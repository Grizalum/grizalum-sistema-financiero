<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Estilos de Flujo de Caja -->
<link rel="stylesheet" href="src/vistas/flujo-caja/flujo-caja.css">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- CONTENEDOR PRINCIPAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="flujoCajaApp" class="flujo-caja-container">
    
    <!-- HEADER PROFESIONAL -->
    <header class="flujo-header">
        <div class="header-titulo">
            <div class="header-icono">
                <i class="fas fa-water"></i>
            </div>
            <div>
                <h1>Flujo de Caja</h1>
                <p class="header-subtitulo">Sistema adaptativo de gestiÃ³n financiera</p>
            </div>
        </div>
        
         <div class="header-acciones">
            <button id="btnExportarRapido" class="btn-secondary">
                <i class="fas fa-download"></i>
                <span>Exportar a Excel</span>
         </button>
          <button id="btnNuevaTransaccion" class="btn-primary" onclick="(function(){ const modal = document.getElementById('modalTransaccion'); if(modal) modal.classList.add('show'); })()">
             <i class="fas fa-plus"></i>
                <span>Nueva TransacciÃ³n</span>
           </button>
        </div>
    </header>

    <!-- NIVEL CON SKELETON LOADER -->
    <div id="nivelBanner" class="nivel-banner" style="display: none;">
        <div class="nivel-info">
            <div class="nivel-icono">
                <div class="skeleton-loader skeleton-circle"></div>
            </div>
            <div class="nivel-textos">
                <div class="nivel-nombre">
                    <div class="skeleton-loader skeleton-title"></div>
                </div>
                <div class="nivel-score">
                    <div class="skeleton-loader skeleton-text" style="width: 100px;"></div>
                </div>
            </div>
        </div>
        <div class="nivel-progreso">
            <div class="progreso-bar">
                <div id="progresoFill" class="progreso-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- BALANCE PRINCIPAL -->
    <section class="balance-principal">
        <div class="balance-card balance-total">
            <div class="balance-icono"><i class="fas fa-gem"></i></div>
            <div class="balance-info">
                <div class="balance-label">Balance Actual</div>
                <div id="balanceTotal" class="balance-monto">S/. 0.00</div>
            </div>
        </div>

        <div class="balance-card balance-ingresos">
            <div class="balance-icono"><i class="fas fa-arrow-trend-up"></i></div>
            <div class="balance-info">
                <div class="balance-label">Ingresos</div>
                <div id="totalIngresos" class="balance-monto">S/. 0.00</div>
                <div id="cantidadIngresos" class="balance-cantidad">0 transacciones</div>
            </div>
        </div>

        <div class="balance-card balance-gastos">
            <div class="balance-icono"><i class="fas fa-arrow-trend-down"></i></div>
            <div class="balance-info">
                <div class="balance-label">Gastos</div>
                <div id="totalGastos" class="balance-monto">S/. 0.00</div>
                <div id="cantidadGastos" class="balance-cantidad">0 transacciones</div>
            </div>
        </div>
    </section>

    <!-- COMPONENTES ADAPTATIVOS -->
    <div id="componentesAdaptativos" class="componentes-adaptativos">
        
        <!-- Buscar Movimientos (Score 20+) -->
<section id="seccionFiltros" class="seccion-componente oculto">
<div class="seccion-header">
    <h3>ğŸ¯ Buscar Movimientos</h3>
</div>
<div class="filtros-contenedor">
    <select id="filtroTipo" class="filtro-select">
        <option value="">ğŸ“Š Todos los tipos</option>
        <option value="ingreso">ğŸ“ˆ Solo Ingresos</option>
        <option value="gasto">ğŸ“‰ Solo Gastos</option>
    </select>

    <select id="filtroCategoria" class="filtro-select">
        <option value="">ğŸ·ï¸ Todas las categorÃ­as</option>
    </select>

    <input type="date" id="filtroFechaInicio" class="filtro-input" placeholder="ğŸ“… Desde">
    <input type="date" id="filtroFechaFin" class="filtro-input" placeholder="ğŸ“… Hasta">

    <button id="btnAplicarFiltros" class="btn-secondary">
        <i class="fas fa-filter"></i> Aplicar Filtros
    </button>

    <button id="btnLimpiarFiltros" class="btn-text">
        <i class="fas fa-times"></i> Limpiar
    </button>
</div>
</section>
        <!-- BUSCADOR (Score 25+) -->
        <section id="seccionBuscador" class="seccion-componente oculto">
            <div class="buscador-contenedor">
                <i class="fas fa-search buscador-icono"></i>
                <input type="text" id="inputBusqueda" class="buscador-input" placeholder="Buscar transacciones...">
            </div>
        </section>

        <!-- GRÃFICOS (Score 30+) -->
        <section id="seccionGraficos" class="seccion-componente oculto">
            <div class="seccion-header">
                <h3>ğŸ“Š GrÃ¡ficos</h3>
            </div>
            <div class="graficos-contenedor">
                <canvas id="graficoMensual" width="400" height="200"></canvas>
            </div>
        </section>

    </div>

    <!-- LISTA DE TRANSACCIONES -->
    <section class="transacciones-seccion">
        <div class="seccion-header">
            <h3>ğŸ“‹ Ãšltimos Movimientos</h3>
            <div id="totalTransacciones" class="total-badge">0</div>
        </div>

        <div id="listaTransacciones" class="transacciones-lista">
            <!-- Las transacciones se cargan dinÃ¡micamente -->
        </div>

        <!-- Estado vacÃ­o mejorado -->
        <div id="sinTransacciones" class="sin-datos empty-state">
            <div class="empty-state__icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div class="empty-state__title">No hay transacciones</div>
            <div class="empty-state__text">
                Comienza agregando tu primer ingreso o gasto para llevar el control de tu flujo de caja
            </div>
            <button class="btn-primary" id="btnPrimeraTransaccion" onclick="abrirModalTransaccion()">
                <i class="fas fa-plus"></i>
                <span>Agregar Primera TransacciÃ³n</span>
            </button>
        </div>
    </section>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL NUEVA TRANSACCIÃ“N -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modalTransaccion" class="modal">
    <div class="modal-contenido">
        <div class="modal-header">
            <h2 id="modalTitulo">Nueva TransacciÃ³n</h2>
            <button class="modal-cerrar" onclick="window.flujoCajaUI.cerrarModalTransaccion()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="formTransaccion" class="modal-body">    
            
            <!-- TIPO -->
            <div class="form-grupo">
                <label class="form-label">Tipo *</label>
                <div class="tipo-selector">
                    <label class="tipo-opcion tipo-ingreso">
                        <input type="radio" name="tipo" value="ingreso" required checked>
                        <div class="tipo-card">
                            <i class="fas fa-arrow-up"></i>
                            <span>Ingreso</span>
                        </div>
                    </label>
                    <label class="tipo-opcion tipo-gasto">
                        <input type="radio" name="tipo" value="gasto" required>
                        <div class="tipo-card">
                            <i class="fas fa-arrow-down"></i>
                            <span>Gasto</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- MONTO -->
            <div class="form-grupo">
                <label for="inputMonto" class="form-label">Monto (S/.) *</label>
                <input type="number" id="inputMonto" class="form-input" 
                        placeholder="0.00" step="0.01" min="0.01" required>
            </div>

            <!-- CATEGORÃA -->
            <div class="form-grupo">
                <label for="selectCategoria" class="form-label">CategorÃ­a *</label>
                <select id="selectCategoria" class="form-select" required>
                    <option value="">Selecciona una categorÃ­a</option>
                    <option value="ventas">Ventas</option>
                    <option value="servicios">Servicios</option>
                    <option value="otros">Otros Ingresos</option>
                </select>
            </div>

         <!-- DESCRIPCIÃ“N -->
            <div class="form-grupo">
                <label for="inputDescripcion" class="form-label">DescripciÃ³n</label>
                <div style="position: relative;">
                    <input type="text" id="inputDescripcion" class="form-input" 
                           placeholder="Ej: Venta de productos"
                           autocomplete="off">
                    <!-- Lista de sugerencias -->
                    <div id="sugerenciasDescripcion" class="sugerencias-container" style="display: none;">
                        <!-- AquÃ­ se cargarÃ¡n las sugerencias dinÃ¡micamente -->
                    </div>
                </div>
            </div>
            <!-- FECHA -->
            <div class="form-grupo">
                <label for="inputFecha" class="form-label">Fecha *</label>
                <input type="date" id="inputFecha" class="form-input" required max="">
            </div>

            <!-- MÃ‰TODO DE PAGO -->
            <div class="form-grupo">
                <label for="selectMetodo" class="form-label">MÃ©todo de Pago</label>
                <select id="selectMetodo" class="form-select">
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="yape">Yape</option>
                    <option value="plin">Plin</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <!-- NOTAS -->
            <div class="form-grupo">
                <label for="inputNotas" class="form-label">Notas adicionales</label>
                <textarea id="inputNotas" class="form-textarea" rows="3" 
                          placeholder="InformaciÃ³n adicional..."></textarea>
            </div>
        </form>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="window.flujoCajaUI.cerrarModalTransaccion()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn-primary" form="formTransaccion">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>
    
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SCRIPTS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VARIABLES GLOBALES
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.transaccionEditando = null;
    console.log('âœ… Variable global inicializada');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIONES DE MODAL (Scope global)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function abrirModalTransaccion() {
        console.log('ğŸ¯ Abriendo modal...');
        
        try {
            window.transaccionEditando = null;
            document.getElementById('modalTitulo').textContent = 'Nueva TransacciÃ³n';
            document.getElementById('formTransaccion').reset();
            document.getElementById('inputFecha').valueAsDate = new Date();
            
            // Cargar categorÃ­as segÃºn tipo seleccionado
            if (window.flujoCaja) {
                actualizarCategoriasSegunTipo();
            }
            
            // Mostrar modal con animaciÃ³n
            const modal = document.getElementById('modalTransaccion');
            modal.classList.add('show');
            
            // Focus en primer campo
            setTimeout(() => {
                document.getElementById('inputMonto').focus();
            }, 300);
            
            console.log('âœ… Modal abierto');
        } catch (error) {
            console.error('âŒ Error abriendo modal:', error);
        }
    }

    function cerrarModalTransaccion() {
        console.log('ğŸ”’ Cerrando modal...');
        document.getElementById('modalTransaccion').classList.remove('show');
        window.transaccionEditando = null;
    }

    function guardarTransaccion(e) {
        e.preventDefault();
        
        console.log('ğŸ’¾ Guardando transacciÃ³n...');
        
        try {
            const datos = {
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                monto: parseFloat(document.getElementById('inputMonto').value),
                categoria: document.getElementById('selectCategoria').value,
                descripcion: document.getElementById('inputDescripcion').value,
                fecha: new Date(document.getElementById('inputFecha').value).toISOString(),
                metodoPago: document.getElementById('selectMetodo').value,
                notas: document.getElementById('inputNotas').value
            };

            if(window.flujoCajaUI.transaccionEditando){
                window.flujoCaja.editarTransaccion(window.flujoCajaUI.transaccionEditando,datos);
            } else {
                window.flujoCaja.agregarTransaccion(datos);
            }

            cerrarModalTransaccion();
            console.log('âœ… TransacciÃ³n guardada');
        } catch (error) {
            console.error('âŒ Error guardando transacciÃ³n:', error);
            alert('Error al guardar la transacciÃ³n. Por favor intenta nuevamente.');
        }
    }

    function editarTransaccion(id) {
        console.log('âœï¸ Editando transacciÃ³n:', id);
        
        try {
            const transaccion = window.flujoCaja.obtenerTransaccion(id);
            
            if (!transaccion) {
                alert('âŒ No se encontrÃ³ la transacciÃ³n');
                console.error('TransacciÃ³n no encontrada:', id);
                return;
            }

            // Guardar ID para saber que estamos editando
            window.transaccionEditando = id;
            
            console.log('ğŸ“ Datos a editar:', transaccion);
            
            // Cambiar tÃ­tulo del modal
            document.getElementById('modalTitulo').textContent = 'Editar TransacciÃ³n';
            
            // Cargar tipo (ingreso/gasto)
            const radioTipo = document.querySelector(`input[name="tipo"][value="${transaccion.tipo}"]`);
            if (radioTipo) {
                radioTipo.checked = true;
            }
            
            // Cargar categorÃ­as segÃºn el tipo
            actualizarCategoriasSegunTipo();
            
            // Esperar mÃ¡s tiempo para que se carguen las categorÃ­as
            setTimeout(() => {
                // Cargar datos en el formulario
                document.getElementById('inputMonto').value = transaccion.monto;
                
                // CRÃTICO: Seleccionar categorÃ­a con verificaciÃ³n
                const selectCategoria = document.getElementById('selectCategoria');
                const categoriaExiste = Array.from(selectCategoria.options).some(opt => opt.value === transaccion.categoria);
                
                if (categoriaExiste) {
                    selectCategoria.value = transaccion.categoria;
                    console.log('âœ… CategorÃ­a seleccionada:', transaccion.categoria);
                } else {
                    console.warn('âš ï¸ CategorÃ­a no encontrada:', transaccion.categoria);
                    // Agregar la categorÃ­a si no existe
                    const option = document.createElement('option');
                    option.value = transaccion.categoria;
                    option.textContent = transaccion.categoria;
                    selectCategoria.appendChild(option);
                    selectCategoria.value = transaccion.categoria;
                }
                
                document.getElementById('inputDescripcion').value = transaccion.descripcion || '';
                
                // Convertir fecha ISO a formato input date (YYYY-MM-DD)
                const fecha = new Date(transaccion.fecha);
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                document.getElementById('inputFecha').value = `${year}-${month}-${day}`;
                
                document.getElementById('selectMetodo').value = transaccion.metodoPago || 'efectivo';
                document.getElementById('inputNotas').value = transaccion.notas || '';
                
                // Abrir modal
                document.getElementById('modalTransaccion').classList.add('show');
                
                // Focus en el monto
                setTimeout(() => {
                    document.getElementById('inputMonto').focus();
                    document.getElementById('inputMonto').select();
                }, 300);
                
                console.log('âœ… Modal de ediciÃ³n cargado con ID:', window.transaccionEditando);
                
            }, 200);
            
        } catch (error) {
            console.error('âŒ Error editando transacciÃ³n:', error);
            alert('âŒ Error al cargar la transacciÃ³n');
        }
    }

    function eliminarTransaccion(id) {
        console.log('ğŸ—‘ï¸ Eliminando transacciÃ³n:', id);
        
        try {
            const transaccion = window.flujoCaja.obtenerTransaccion(id);
            
            if (!transaccion) {
                alert('âŒ No se encontrÃ³ la transacciÃ³n');
                return;
            }
            
            // Crear modal de confirmaciÃ³n personalizado
            const confirmar = confirm(
                `Â¿Eliminar esta transacciÃ³n?\n\n` +
                `Tipo: ${transaccion.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'}\n` +
                `Monto: S/ ${transaccion.monto.toFixed(2)}\n` +
                `CategorÃ­a: ${transaccion.categoria}\n` +
                `DescripciÃ³n: ${transaccion.descripcion || 'Sin descripciÃ³n'}`
            );
            
            if (!confirmar) {
                console.log('âš ï¸ EliminaciÃ³n cancelada');
                return;
            }
            
            // Eliminar
            window.flujoCaja.eliminarTransaccion(id);
            
            console.log('âœ… TransacciÃ³n eliminada');
            
            // Mostrar notificaciÃ³n
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
                z-index: 999999;
                font-weight: 700;
                font-size: 0.875rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                animation: slideIn 0.3s ease;
            `;
            notif.innerHTML = '<i class="fas fa-trash"></i> TransacciÃ³n eliminada';
            document.body.appendChild(notif);
            
            // Remover notificaciÃ³n
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 2500);
            
        } catch (error) {
            console.error('âŒ Error eliminando transacciÃ³n:', error);
            alert('âŒ Error al eliminar la transacciÃ³n');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIONES DE CARGA DE DATOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.cargarNivel = function() {
        try {
            const info = window.flujoCaja?.obtenerInfo();
            const nivelBanner = document.getElementById('nivelBanner');
            
            console.log('ğŸ¯ [cargarNivel] Ejecutando...', {
                tieneInfo: !!info,
                tieneNivel: !!info?.nivel,
                nivel: info?.nivel?.nivel?.nombre
            });
            
            if (!nivelBanner) {
                console.warn('âš ï¸ Banner de nivel no encontrado');
                return;
            }
            
            if (!info || !info.nivel) {
                console.warn('âš ï¸ No hay info de nivel, ocultando banner');
                nivelBanner.style.display = 'none';
                return;
            }

            console.log('âœ… [cargarNivel] Mostrando nivel:', info.nivel.nivel.nombre);
            nivelBanner.style.display = 'flex';

            nivelBanner.innerHTML = `
                <div class="nivel-info">
                    <span class="nivel-icono" style="font-size: 2.5rem;">${info.nivel.nivel.icono}</span>
                    <div class="nivel-textos">
                        <div class="nivel-nombre" style="font-size: 1.25rem; font-weight: 700; color: var(--texto-principal);">
                            Nivel ${info.nivel.nivel.nombre}
                        </div>
                        <div class="nivel-score" style="font-size: 0.875rem; color: var(--texto-terciario);">
                            Score: ${info.nivel.score}/100
                        </div>
                    </div>
                </div>
                <div class="nivel-progreso">
                    <div class="progreso-bar">
                        <div class="progreso-fill" style="width: ${info.nivel.score}%"></div>
                    </div>
                </div>
            `;
            
            mostrarComponentesSegunNivel(info.componentesActivos);
        } catch (error) {
            console.error('âŒ Error cargando nivel:', error);
            const nivelBanner = document.getElementById('nivelBanner');
            if (nivelBanner) {
                nivelBanner.style.display = 'none';
            }
        }
    }

    function mostrarComponentesSegunNivel(componentes) {
        try {
            if (componentes.mejorasBasicas?.filtrosFecha?.activo) {
                document.getElementById('seccionFiltros')?.classList.remove('oculto');
            }

            if (componentes.mejorasBasicas?.busqueda?.activo) {
                document.getElementById('seccionBuscador')?.classList.remove('oculto');
            }

            if (componentes.visualizacionAvanzada?.graficosBasicos?.activo) {
                document.getElementById('seccionGraficos')?.classList.remove('oculto');
            }

            if (componentes.visualizacionAvanzada?.exportarExcel?.activo) {
                document.getElementById('seccionExportar')?.classList.remove('oculto');
            }
        } catch (error) {
            console.error('âŒ Error mostrando componentes:', error);
        }
    }

    window.cargarCategorias = function() {
        try {
            const info = window.flujoCaja.obtenerInfo();
            
            if (!info || !info.categorias) {
                console.warn('âš ï¸ No se pudieron cargar las categorÃ­as');
                const categoriasDefault = {
                    ingresos: ['Ventas', 'Servicios', 'Otros Ingresos'],
                    gastos: ['Compras', 'Servicios', 'Gastos Operativos', 'Otros Gastos']
                };
                actualizarSelectCategorias(categoriasDefault.ingresos);
                return;
            }
            
            actualizarSelectCategorias(info.categorias.ingresos);
            console.log('âœ… CategorÃ­as cargadas');
        } catch (error) {
            console.error('âŒ Error cargando categorÃ­as:', error);
            actualizarSelectCategorias(['Ventas', 'Servicios', 'Otros']);
        }
    }

    function actualizarCategoriasSegunTipo() {
        try {
            const tipo = document.querySelector('input[name="tipo"]:checked').value;
            const info = window.flujoCaja.obtenerInfo();
            
            const categorias = tipo === 'ingreso' 
                ? info.categorias.ingresos 
                : info.categorias.gastos;
            
            actualizarSelectCategorias(categorias);
        } catch (error) {
            console.error('âŒ Error actualizando categorÃ­as:', error);
        }
    }

    function actualizarSelectCategorias(categorias) {
        const select = document.getElementById('selectCategoria');
        select.innerHTML = '<option value="">Selecciona una categorÃ­a</option>';
        
        categorias.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });

        const filtroSelect = document.getElementById('filtroCategoria');
        if (filtroSelect && window.flujoCaja) {
            const valorActual = filtroSelect.value;
            filtroSelect.innerHTML = '<option value="">Todas las categorÃ­as</option>';
            
            const todasCategorias = [...new Set([
                ...window.flujoCaja.obtenerInfo().categorias.ingresos,
                ...window.flujoCaja.obtenerInfo().categorias.gastos
            ])];
            
            todasCategorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filtroSelect.appendChild(option);
            });
            
            filtroSelect.value = valorActual;
        }
    }

    window.cargarBalance = function() {
        try {
            const balance = window.flujoCaja.calcularBalance();
            
            document.getElementById('balanceTotal').textContent = formatearMoneda(balance.balance);
            document.getElementById('totalIngresos').textContent = formatearMoneda(balance.ingresos);
            document.getElementById('totalGastos').textContent = formatearMoneda(balance.gastos);
            
            document.getElementById('cantidadIngresos').textContent = `${balance.cantidadIngresos} transacciÃ³n${balance.cantidadIngresos !== 1 ? 'es' : ''}`;
            document.getElementById('cantidadGastos').textContent = `${balance.cantidadGastos} transacciÃ³n${balance.cantidadGastos !== 1 ? 'es' : ''}`;
            
            console.log('âœ… Balance actualizado');
        } catch (error) {
            console.error('âŒ Error cargando balance:', error);
        }
    }

    window.cargarTransacciones = function(filtros = {}) {
        try {
            const transacciones = window.flujoCaja.obtenerTransacciones(filtros);
            const lista = document.getElementById('listaTransacciones');
            const sinDatos = document.getElementById('sinTransacciones');
            const totalBadge = document.getElementById('totalTransacciones');

            totalBadge.textContent = transacciones.length;

            if (transacciones.length === 0) {
                lista.style.display = 'none';
                sinDatos.style.display = 'flex';
                return;
            }

            lista.style.display = 'block';
            sinDatos.style.display = 'none';

            lista.innerHTML = transacciones.map(t => crearTarjetaTransaccion(t)).join('');
            console.log(`âœ… ${transacciones.length} transacciones cargadas`);
        } catch (error) {
            console.error('âŒ Error cargando transacciones:', error);
        }
    }

    function crearTarjetaTransaccion(transaccion) {
        const fecha = new Date(transaccion.fecha);
        const esIngreso = transaccion.tipo === 'ingreso';
        
        return `
            <div class="transaccion-card ${transaccion.tipo}">
                <div class="transaccion-icono ${transaccion.tipo}">
                    <i class="fas fa-arrow-${esIngreso ? 'up' : 'down'}"></i>
                </div>
                <div class="transaccion-info">
                    <div class="transaccion-descripcion">${transaccion.descripcion || transaccion.categoria}</div>
                    <div class="transaccion-detalles">
                        <span class="transaccion-categoria">${transaccion.categoria}</span>
                        <span class="transaccion-fecha">${fecha.toLocaleDateString('es-PE')}</span>
                    </div>
                </div>
                <div class="transaccion-monto ${transaccion.tipo}">
                    ${esIngreso ? '+' : '-'} ${formatearMoneda(transaccion.monto)}
                </div>
                <div class="transaccion-acciones">
                    <button class="btn-icono" onclick="editarTransaccion('${transaccion.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icono" onclick="eliminarTransaccion('${transaccion.id}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function aplicarFiltros() {
        const filtros = {
            tipo: document.getElementById('filtroTipo').value,
            categoria: document.getElementById('filtroCategoria').value,
            fechaInicio: document.getElementById('filtroFechaInicio').value ? new Date(document.getElementById('filtroFechaInicio').value).toISOString() : null,
            fechaFin: document.getElementById('filtroFechaFin').value ? new Date(document.getElementById('filtroFechaFin').value).toISOString() : null
        };

        cargarTransacciones(filtros);
    }

    function limpiarFiltros() {
        document.getElementById('filtroTipo').value = '';
        document.getElementById('filtroCategoria').value = '';
        document.getElementById('filtroFechaInicio').value = '';
        document.getElementById('filtroFechaFin').value = '';
        cargarTransacciones();
    }

    function buscarTransacciones(texto) {
        cargarTransacciones({ busqueda: texto });
    }

    function formatearMoneda(valor) {
        return new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN'
        }).format(valor);    
    }

    function configurarEventos() {
        console.log('âš™ï¸ Configurando eventos...');
        
        const btnNueva = document.getElementById('btnNuevaTransaccion');
        if (btnNueva) {
            btnNueva.addEventListener('click', abrirModalTransaccion);
        }
        
        const btnPrimera = document.getElementById('btnPrimeraTransaccion');
        if (btnPrimera) {
            btnPrimera.addEventListener('click', abrirModalTransaccion);
        }

        document.querySelectorAll('input[name="tipo"]').forEach(radio => {
            radio.addEventListener('change', actualizarCategoriasSegunTipo);
        });

        const btnAplicar = document.getElementById('btnAplicarFiltros');
        if (btnAplicar) {
            btnAplicar.addEventListener('click', aplicarFiltros);
        }
        
        const btnLimpiar = document.getElementById('btnLimpiarFiltros');
        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', limpiarFiltros);
        }

        let timeoutBusqueda;
        const inputBusqueda = document.getElementById('inputBusqueda');
        if (inputBusqueda) {
            inputBusqueda.addEventListener('input', function(e) {
                clearTimeout(timeoutBusqueda);
                timeoutBusqueda = setTimeout(() => buscarTransacciones(e.target.value), 500);
            });
        }

        const btnExportar = document.getElementById('btnExportar');
        if (btnExportar) {
            btnExportar.addEventListener('click', () => {
                if (window.flujoCajaUI && window.flujoCajaUI.exportarDatos) {
                    window.flujoCajaUI.exportarDatos();
                }
            });
        }
        
        const btnExportarRapido = document.getElementById('btnExportarRapido');
        if (btnExportarRapido) {
            btnExportarRapido.addEventListener('click', () => {
                if (window.flujoCajaUI && window.flujoCajaUI.exportarDatos) {
                    window.flujoCajaUI.exportarDatos();
                }
            });
        }

        document.addEventListener('grizalumTransaccionAgregada', () => {
            cargarBalance();
            cargarTransacciones();
        });

        document.addEventListener('grizalumTransaccionEditada', () => {
            cargarBalance();
            cargarTransacciones();
        });

        document.addEventListener('grizalumTransaccionEliminada', () => {
            cargarBalance();
            cargarTransacciones();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarModalTransaccion();
            }
        });
        
        const modal = document.getElementById('modalTransaccion');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    cerrarModalTransaccion();
                }
            });
        }
        
        console.log('âœ… Eventos configurados');
    }

    function inicializarFlujoCaja() {
        console.log('ğŸš€ Inicializando Flujo de Caja...');
        
        const fechaInput = document.getElementById('inputFecha');
        if (fechaInput) {
            const hoy = new Date().toISOString().split('T')[0];
            fechaInput.valueAsDate = new Date();
            fechaInput.max = hoy;
        }
        
        configurarEventos();
        
        // âœ… ESPERAR a que window.flujoCaja exista ANTES de cargar datos
        let intentos = 0;
        const esperarFlujoCaja = setInterval(() => {
            intentos++;
            if (window.flujoCaja && typeof window.flujoCaja.obtenerInfo === 'function') {
                clearInterval(esperarFlujoCaja);
                console.log('âœ… FlujoCaja detectado, cargando datos...');
                cargarDatosIniciales();
            } else if (intentos > 100) {
                clearInterval(esperarFlujoCaja);
                console.error('âŒ Timeout: FlujoCaja no se cargÃ³ en 10 segundos');
            }
        }, 100);
    }
    
    function cargarDatosIniciales() {
        console.log('ğŸ“Š Cargando datos iniciales...');
        
        try {
            cargarCategorias();
            cargarBalance();
            cargarTransacciones();
            
            // âœ… CARGAR NIVEL CON RETRY AUTOMÃTICO
            let intentosNivel = 0;
            const maxIntentos = 10;
            
            const cargarNivelConRetry = () => {
                intentosNivel++;
                console.log(`ğŸ¯ Intento ${intentosNivel}/${maxIntentos} de cargar nivel...`);
                
                const banner = document.getElementById('nivelBanner');
                const info = window.flujoCaja?.obtenerInfo();
                
                if (banner && info?.nivel) {
                    console.log('âœ… Banner y datos listos, cargando nivel...');
                    cargarNivel();
                } else {
                    console.warn(`âš ï¸ Banner: ${!!banner}, Info: ${!!info?.nivel}`);
                    if (intentosNivel < maxIntentos) {
                        setTimeout(cargarNivelConRetry, 150);
                    } else {
                        console.error('âŒ No se pudo cargar el nivel despuÃ©s de ' + maxIntentos + ' intentos');
                    }
                }
            };
            
            // Iniciar retry despuÃ©s de 100ms
            setTimeout(cargarNivelConRetry, 100);
            
            console.log('âœ… Flujo de Caja listo');
            
            const transacciones = window.flujoCaja.obtenerTransacciones();
            console.log(`ğŸ“‹ ${transacciones.length} transacciones cargadas`);
            
        } catch (error) {
            console.error('âŒ Error cargando datos iniciales:', error);
        }
    }

    // âœ… LISTENER PARA CUANDO SE INICIALIZA EL MÃ“DULO
document.addEventListener('grizalumFlujoCajaInicializado', () => {
    console.log('ğŸ¯ Evento FlujoCaja inicializado detectado');
    setTimeout(() => {
        if (window.cargarNivel) {
            cargarNivel();
        }
    }, 100);
});

// âœ… LISTENER PARA CUANDO SE CAMBIA A ESTA VISTA - CON RETRY
document.addEventListener('sectionChanged', (evento) => {
    if (evento.detail.to === 'flujo-caja') {
        let intentos = 0;
        const mostrar = () => {
            intentos++;
            const banner = document.getElementById('nivelBanner');
            const info = window.flujoCaja?.obtenerInfo();
            
            if (banner && info?.nivel) {
                banner.style.display = 'flex';
                banner.innerHTML = `<div class="nivel-info"><span class="nivel-icono" style="font-size: 2.5rem;">${info.nivel.nivel.icono}</span><div class="nivel-textos"><div class="nivel-nombre" style="font-size: 1.25rem; font-weight: 700;">Nivel ${info.nivel.nivel.nombre}</div><div class="nivel-score" style="font-size: 0.875rem;">Score: ${info.nivel.score}/100</div></div></div>`;
            } else if (intentos < 10) {
                setTimeout(mostrar, 100);
            }
        };
        setTimeout(mostrar, 50);
    }
});

// âœ… INICIAR TODO
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarFlujoCaja);
} else {
    inicializarFlujoCaja();
}

    // âœ… FUNCIÃ“N DE RECARGA GLOBAL
    window.recargarFlujoCaja = function() {
        console.log('ğŸ”„ Recargando Flujo de Caja...');
        
        if (!window.flujoCaja) {
            console.warn('âš ï¸ MÃ³dulo flujoCaja no disponible');
            return;
        }
        
        try {
            const transacciones = window.flujoCaja.obtenerTransacciones();
            const lista = document.getElementById('listaTransacciones');
            const sinDatos = document.getElementById('sinTransacciones');
            const totalBadge = document.getElementById('totalTransacciones');
            
            if (!lista) {
                console.warn('âš ï¸ Elementos DOM no encontrados');
                return;
            }
            
            totalBadge.textContent = transacciones.length;
            
            if (transacciones.length === 0) {
                lista.style.display = 'none';
                sinDatos.style.display = 'flex';
                return;
            }
            
            lista.style.display = 'block';
            sinDatos.style.display = 'none';
            
            lista.innerHTML = transacciones.map(t => {
                const fecha = new Date(t.fecha);
                const esIngreso = t.tipo === 'ingreso';
                return `
                    <div class="transaccion-card ${t.tipo}">
                        <div class="transaccion-icono ${t.tipo}">
                            <i class="fas fa-arrow-${esIngreso ? 'up' : 'down'}"></i>
                        </div>
                        <div class="transaccion-info">
                            <div class="transaccion-descripcion">${t.descripcion || t.categoria}</div>
                            <div class="transaccion-detalles">
                                <span class="transaccion-categoria">${t.categoria}</span>
                                <span class="transaccion-fecha">${fecha.toLocaleDateString('es-PE')}</span>
                            </div>
                        </div>
                        <div class="transaccion-monto ${t.tipo}">
                            ${esIngreso ? '+' : '-'} S/. ${t.monto.toFixed(2)}
                        </div>
                        <div class="transaccion-acciones">
                            <button class="btn-icono" onclick="editarTransaccion('${t.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icono" onclick="eliminarTransaccion('${t.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const balance = window.flujoCaja.calcularBalance();
            document.getElementById('balanceTotal').textContent = new Intl.NumberFormat('es-PE', {style: 'currency', currency: 'PEN'}).format(balance.balance);
            document.getElementById('totalIngresos').textContent = new Intl.NumberFormat('es-PE', {style: 'currency', currency: 'PEN'}).format(balance.ingresos);
            document.getElementById('totalGastos').textContent = new Intl.NumberFormat('es-PE', {style: 'currency', currency: 'PEN'}).format(balance.gastos);
            document.getElementById('cantidadIngresos').textContent = `${balance.cantidadIngresos} transacciÃ³n${balance.cantidadIngresos !== 1 ? 'es' : ''}`;
            document.getElementById('cantidadGastos').textContent = `${balance.cantidadGastos} transacciÃ³n${balance.cantidadGastos !== 1 ? 'es' : ''}`;
            
            console.log(`âœ… ${transacciones.length} transacciones mostradas`);
            
        } catch (error) {
            console.error('âŒ Error recargando:', error);
        }
    };
    
    console.log('âœ… FunciÃ³n global recargarFlujoCaja creada');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SISTEMA DE PLANES - DIRECTO EN HTML
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.FlujoCajaPlanes = {
        PLANES: {
            individual: { nombre: 'Individual', icono: 'ğŸ‘¤', precio: 19, color: '#6366f1' },
            profesional: { nombre: 'Profesional', icono: 'ğŸ’¼', precio: 49, color: '#8b5cf6' },
            empresarial: { nombre: 'Empresarial', icono: 'ğŸ¢', precio: 99, color: '#ec4899' },
            corporativo: { nombre: 'Corporativo', icono: 'ğŸŒ', precio: 299, color: '#f59e0b' }
        },
        obtenerPlanActual() {
            const planId = localStorage.getItem('grizalum_planActual') || 'individual';
            return this.PLANES[planId] || this.PLANES.individual;
        },
        cambiarPlan(planId) {
            if (this.PLANES[planId]) {
                localStorage.setItem('grizalum_planActual', planId);
                location.reload();
            }
        }
    };
    
    // Cargador de Plan
    (function() {
        console.log('ğŸ¯ [Plan-HTML] Iniciando...');
        
        function mostrarPlan() {
            const banner = document.getElementById('nivelBanner');
            const plan = window.FlujoCajaPlanes.obtenerPlanActual();
            
            if (banner && plan) {
                banner.style.display = 'flex';
                banner.innerHTML = `
                    <div class="nivel-info">
                        <span class="nivel-icono" style="font-size: 2.5rem;">${plan.icono}</span>
                        <div class="nivel-textos">
                            <div class="nivel-nombre" style="font-size: 1.25rem; font-weight: 700;">
                                Plan ${plan.nombre}
                            </div>
                            <div class="nivel-score" style="font-size: 0.875rem;">
                                $${plan.precio}/mes
                            </div>
                        </div>
                    </div>
                `;
                return true;
            }
            return false;
        }
        
        document.addEventListener('sectionChanged', function(e) {
            if (e.detail.to === 'flujo-caja') {
                console.log('ğŸš€ [Plan-HTML] Cargando plan...');
                let i = 0;
                const r = () => { if (!mostrarPlan() && i++ < 15) setTimeout(r, 100); };
                setTimeout(r, 50);
            }
        });
        
        setTimeout(() => {
            if (document.getElementById('flujoCajaApp')?.offsetParent !== null) {
                console.log('âš¡ [Plan-HTML] DetecciÃ³n inicial');
                let i = 0;
                const r = () => { if (!mostrarPlan() && i++ < 15) setTimeout(r, 100); };
                r();
            }
        }, 200);
        
        console.log('âœ… [Plan-HTML] Listo');
    })();
    

</script>

<!-- SCRIPTS DEL MÃ“DULO CON TIMESTAMP ÃšNICO -->
<script src="src/vistas/flujo-caja/flujo-caja-config.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/historial-descripciones.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja-exportador-profesional.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja-ui.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja-graficos.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja-categorias.js?v=1761876700"></script>
<script src="src/vistas/flujo-caja/flujo-caja-planes.js?v=1762235000"></script>
<script src="src/vistas/flujo-caja/flujo-caja-plan-loader.js?v=1762235000"></script>
<script src="src/vistas/flujo-caja/flujo-caja-nivel-loader.js?v=1762209523"></script>

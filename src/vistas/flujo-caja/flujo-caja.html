<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo de Caja - GRIZALUM</title>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="modo-oscuro">

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="flujoCajaApp" class="flujo-caja-container">
        
        <!-- HEADER PROFESIONAL -->
        <header class="flujo-header">
            <div class="header-titulo">
                <div class="header-icono">
                    <i class="fas fa-water"></i>
                </div>
                <div>
                    <h1>Flujo de Caja</h1>
                    <p class="header-subtitulo">Sistema adaptativo de gestión financiera</p>
                </div>
            </div>
            
            <div class="header-acciones">
                <button id="btnExportarRapido" class="btn-secondary">
                    <i class="fas fa-download"></i>
                    <span>Exportar</span>
                </button>
               <button id="btnNuevaTransaccion" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    <span>Nueva Transacción</span>
                </button>
            </div>
        </header>

        <!-- NIVEL CON SKELETON LOADER -->
        <div id="nivelBanner" class="nivel-banner" style="display: none;">
            <div class="nivel-info">
                <div class="nivel-icono">
                    <div class="skeleton-loader skeleton-circle"></div>
                </div>
                <div class="nivel-textos">
                    <div class="nivel-nombre">
                        <div class="skeleton-loader skeleton-title"></div>
                    </div>
                    <div class="nivel-score">
                        <div class="skeleton-loader skeleton-text" style="width: 100px;"></div>
                    </div>
                </div>
            </div>
            <div class="nivel-progreso">
                <div class="progreso-bar">
                    <div id="progresoFill" class="progreso-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- BALANCE PRINCIPAL -->
        <section class="balance-principal">
            <div class="balance-card balance-total">
                <div class="balance-icono"><i class="fas fa-gem"></i></div>
                <div class="balance-info">
                    <div class="balance-label">Balance Actual</div>
                    <div id="balanceTotal" class="balance-monto">S/. 0.00</div>
                </div>
            </div>

            <div class="balance-card balance-ingresos">
                <div class="balance-icono"><i class="fas fa-arrow-trend-up"></i></div>
                <div class="balance-info">
                    <div class="balance-label">Ingresos</div>
                    <div id="totalIngresos" class="balance-monto">S/. 0.00</div>
                    <div id="cantidadIngresos" class="balance-cantidad">0 transacciones</div>
                </div>
            </div>

            <div class="balance-card balance-gastos">
                <div class="balance-icono"><i class="fas fa-arrow-trend-down"></i></div>
                <div class="balance-info">
                    <div class="balance-label">Gastos</div>
                    <div id="totalGastos" class="balance-monto">S/. 0.00</div>
                    <div id="cantidadGastos" class="balance-cantidad">0 transacciones</div>
                </div>
            </div>
        </section>

        <!-- COMPONENTES ADAPTATIVOS -->
        <div id="componentesAdaptativos" class="componentes-adaptativos">
            
            <!-- FILTROS -->
            <section id="seccionFiltros" class="seccion-componente oculto">
                <div class="seccion-header">
                    <h3>📅 Filtros</h3>
                </div>
                <div class="filtros-contenedor">
                    <select id="filtroTipo" class="filtro-select">
                        <option value="">Todos los tipos</option>
                        <option value="ingreso">Solo Ingresos</option>
                        <option value="gasto">Solo Gastos</option>
                    </select>

                    <select id="filtroCategoria" class="filtro-select">
                        <option value="">Todas las categorías</option>
                    </select>

                    <input type="date" id="filtroFechaInicio" class="filtro-input" placeholder="Fecha inicio">
                    <input type="date" id="filtroFechaFin" class="filtro-input" placeholder="Fecha fin">

                    <button id="btnAplicarFiltros" class="btn-secondary">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>

                    <button id="btnLimpiarFiltros" class="btn-text">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </section>

            <!-- BUSCADOR -->
            <section id="seccionBuscador" class="seccion-componente oculto">
                <div class="buscador-contenedor">
                    <i class="fas fa-search buscador-icono"></i>
                    <input type="text" id="inputBusqueda" class="buscador-input" placeholder="Buscar transacciones...">
                </div>
            </section>

            <!-- GRÁFICOS -->
            <section id="seccionGraficos" class="seccion-componente oculto">
                <div class="seccion-header">
                    <h3>📊 Gráficos</h3>
                </div>
                <div class="graficos-contenedor">
                    <canvas id="graficoMensual" width="400" height="200"></canvas>
                </div>
            </section>

            <!-- EXPORTAR -->
            <section id="seccionExportar" class="seccion-componente oculto">
                <button id="btnExportar" class="btn-secondary">
                    <i class="fas fa-download"></i> Exportar a Excel
                </button>
            </section>

        </div>

        <!-- LISTA DE TRANSACCIONES -->
        <section class="transacciones-seccion">
            <div class="seccion-header">
                <h3>📋 Últimos Movimientos</h3>
                <div id="totalTransacciones" class="total-badge">0</div>
            </div>

            <div id="listaTransacciones" class="transacciones-lista"></div>

            <div id="sinTransacciones" class="sin-datos empty-state">
                <div class="empty-state__icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <div class="empty-state__title">No hay transacciones</div>
                <div class="empty-state__text">
                    Comienza agregando tu primer ingreso o gasto para llevar el control de tu flujo de caja
                </div>
                <button class="btn-primary" id="btnPrimeraTransaccion">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Primera Transacción</span>
                </button>
            </div>
        </section>

    </div>

    <!-- MODAL NUEVA TRANSACCIÓN -->
    <div id="modalTransaccion" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 id="modalTitulo">Nueva Transacción</h2>
                <button class="modal-cerrar" id="btnCerrarModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="formTransaccion" class="modal-body">
                
                <!-- TIPO -->
                <div class="form-grupo">
                    <label class="form-label">Tipo *</label>
                    <div class="tipo-selector">
                        <label class="tipo-opcion tipo-ingreso">
                            <input type="radio" name="tipo" value="ingreso" required checked>
                            <div class="tipo-card">
                                <i class="fas fa-arrow-up"></i>
                                <span>Ingreso</span>
                            </div>
                        </label>
                        <label class="tipo-opcion tipo-gasto">
                            <input type="radio" name="tipo" value="gasto" required>
                            <div class="tipo-card">
                                <i class="fas fa-arrow-down"></i>
                                <span>Gasto</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- MONTO -->
                <div class="form-grupo">
                    <label for="inputMonto" class="form-label">Monto (S/.) *</label>
                    <input type="number" id="inputMonto" class="form-input" 
                           placeholder="0.00" step="0.01" min="0" required>
                </div>

                <!-- CATEGORÍA -->
                <div class="form-grupo">
                    <label for="selectCategoria" class="form-label">Categoría *</label>
                    <select id="selectCategoria" class="form-select" required>
                        <option value="">Selecciona una categoría</option>
                    </select>
                </div>

                <!-- DESCRIPCIÓN -->
                <div class="form-grupo">
                    <label for="inputDescripcion" class="form-label">Descripción</label>
                    <input type="text" id="inputDescripcion" class="form-input" 
                           placeholder="Ej: Venta de productos">
                </div>

                <!-- FECHA -->
                <div class="form-grupo">
                    <label for="inputFecha" class="form-label">Fecha *</label>
                    <input type="date" id="inputFecha" class="form-input" required>
                </div>

                <!-- MÉTODO DE PAGO -->
                <div class="form-grupo">
                    <label for="selectMetodo" class="form-label">Método de Pago</label>
                    <select id="selectMetodo" class="form-select">
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="yape">Yape</option>
                        <option value="plin">Plin</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <!-- NOTAS -->
                <div class="form-grupo">
                    <label for="inputNotas" class="form-label">Notas adicionales</label>
                    <textarea id="inputNotas" class="form-textarea" rows="3" 
                              placeholder="Información adicional..."></textarea>
                </div>

            </form>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="btnCancelarModal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn-primary" id="btnGuardarTransaccion">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // ═══════════════════════════════════════════════════════════════
        // VARIABLE GLOBAL
        // ═══════════════════════════════════════════════════════════════
        window.transaccionEditando = null;
        console.log('🔧 Variable global inicializada');

        // ═══════════════════════════════════════════════════════════════
        // FUNCIONES DE MODAL
        // ═══════════════════════════════════════════════════════════════
        function abrirModalTransaccion() {
            console.log('🎯 Abriendo modal...');
            
            window.transaccionEditando = null;
            document.getElementById('modalTitulo').textContent = 'Nueva Transacción';
            document.getElementById('formTransaccion').reset();
            document.getElementById('inputFecha').valueAsDate = new Date();
            
            if (window.flujoCaja) {
                actualizarCategoriasSegunTipo();
            }
            
            document.getElementById('modalTransaccion').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('inputMonto').focus();
            }, 300);
        }

        function cerrarModalTransaccion() {
            document.getElementById('modalTransaccion').classList.remove('show');
            window.transaccionEditando = null;
        }

        function guardarTransaccion() {
            console.log('💾 Guardando transacción...');
            
            const monto = document.getElementById('inputMonto').value;
            const categoria = document.getElementById('selectCategoria').value;
            const fecha = document.getElementById('inputFecha').value;
            
            if (!monto || !categoria || !fecha) {
                alert('⚠️ Completa todos los campos obligatorios');
                return;
            }
            
            const datos = {
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                monto: parseFloat(monto),
                categoria: categoria,
                descripcion: document.getElementById('inputDescripcion').value || '',
                fecha: new Date(fecha).toISOString(),
                metodoPago: document.getElementById('selectMetodo').value || 'efectivo',
                notas: document.getElementById('inputNotas').value || ''
            };
            
            console.log('📝 Datos:', datos);
            console.log('🔧 ID editando:', window.transaccionEditando);
            
            if (window.transaccionEditando) {
                console.log('✏️ EDITANDO ID:', window.transaccionEditando);
                window.flujoCaja.editarTransaccion(window.transaccionEditando, datos);
                window.transaccionEditando = null;
            } else {
                console.log('➕ CREANDO nueva');
                window.flujoCaja.agregarTransaccion(datos);
            }
            
            cerrarModalTransaccion();
            
            const notif = document.createElement('div');
            notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:1rem 1.5rem;border-radius:12px;z-index:999999;font-weight:700;';
            notif.innerHTML = '✅ Guardado';
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
            
            setTimeout(() => {
                cargarBalance();
                cargarTransacciones();
            }, 100);
        }

        function editarTransaccion(id) {
            console.log('✏️ Editando:', id);
            
            const transaccion = window.flujoCaja.obtenerTransaccion(id);
            
            if (!transaccion) {
                alert('❌ No se encontró la transacción');
                return;
            }

            window.transaccionEditando = id;
            
            document.getElementById('modalTitulo').textContent = 'Editar Transacción';
            
            const radioTipo = document.querySelector(`input[name="tipo"][value="${transaccion.tipo}"]`);
            if (radioTipo) radioTipo.checked = true;
            
            actualizarCategoriasSegunTipo();
            
            setTimeout(() => {
                document.getElementById('inputMonto').value = transaccion.monto;
                
                const selectCategoria = document.getElementById('selectCategoria');
                const categoriaExiste = Array.from(selectCategoria.options).some(opt => opt.value === transaccion.categoria);
                
                if (categoriaExiste) {
                    selectCategoria.value = transaccion.categoria;
                } else {
                    const option = document.createElement('option');
                    option.value = transaccion.categoria;
                    option.textContent = transaccion.categoria;
                    selectCategoria.appendChild(option);
                    selectCategoria.value = transaccion.categoria;
                }
                
                document.getElementById('inputDescripcion').value = transaccion.descripcion || '';
                
                const fecha = new Date(transaccion.fecha);
                const year = fecha.getFullYear();
                const month = String(fecha.getMonth() + 1).padStart(2, '0');
                const day = String(fecha.getDate()).padStart(2, '0');
                document.getElementById('inputFecha').value = `${year}-${month}-${day}`;
                
                document.getElementById('selectMetodo').value = transaccion.metodoPago || 'efectivo';
                document.getElementById('inputNotas').value = transaccion.notas || '';
                
                document.getElementById('modalTransaccion').classList.add('show');
                
                setTimeout(() => {
                    document.getElementById('inputMonto').focus();
                    document.getElementById('inputMonto').select();
                }, 300);
                
                console.log('✅ Modal listo. ID:', window.transaccionEditando);
                
            }, 200);
        }

        function eliminarTransaccion(id) {
            console.log('🗑️ Eliminando:', id);
            
            const transaccion = window.flujoCaja.obtenerTransaccion(id);
            
            if (!transaccion) {
                alert('❌ No se encontró');
                return;
            }
            
            const confirmar = confirm(
                `¿Eliminar?\n\n` +
                `Tipo: ${transaccion.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'}\n` +
                `Monto: S/ ${transaccion.monto.toFixed(2)}\n` +
                `Categoría: ${transaccion.categoria}`
            );
            
            if (!confirmar) return;
            
            window.flujoCaja.eliminarTransaccion(id);
            
            const notif = document.createElement('div');
            notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:1rem 1.5rem;border-radius:12px;z-index:999999;font-weight:700;';
            notif.innerHTML = '<i class="fas fa-trash"></i> Eliminado';
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 2500);
        }

        // ═══════════════════════════════════════════════════════════════
        // FUNCIONES DE CARGA
        // ═══════════════════════════════════════════════════════════════
        function cargarNivel() {
            const info = window.flujoCaja?.obtenerInfo();
            
            if (!info || !info.nivel) {
                document.getElementById('nivelBanner').style.display = 'none';
                return;
            }

            document.getElementById('nivelBanner').style.display = 'flex';

            const banner = document.getElementById('nivelBanner');
            banner.innerHTML = `
                <div class="nivel-info">
                    <span class="nivel-icono" style="font-size: 2.5rem;">${info.nivel.nivel.icono}</span>
                    <div class="nivel-textos">
                        <div class="nivel-nombre" style="font-size: 1.25rem; font-weight: 700;">
                            Nivel ${info.nivel.nivel.nombre}
                        </div>
                        <div class="nivel-score" style="font-size: 0.875rem;">
                            Score: ${info.nivel.score}/100
                        </div>
                    </div>
                </div>
                <div class="nivel-progreso">
                    <div class="progreso-bar">
                        <div class="progreso-fill" style="width: ${info.nivel.score}%"></div>
                    </div>
                </div>
            `;
            
            mostrarComponentesSegunNivel(info.componentesActivos);
        }

        function mostrarComponentesSegunNivel(componentes) {
            if (componentes.mejorasBasicas?.filtrosFecha?.activo) {
                document.getElementById('seccionFiltros')?.classList.remove('oculto');
            }
            if (componentes.mejorasBasicas?.busqueda?.activo) {
                document.getElementById('seccionBuscador')?.classList.remove('oculto');
            }
            if (componentes.visualizacionAvanzada?.graficosBasicos?.activo) {
                document.getElementById('seccionGraficos')?.classList.remove('oculto');
            }
            if (componentes.visualizacionAvanzada?.exportarExcel?.activo) {
                document.getElementById('seccionExportar')?.classList.remove('oculto');
            }
        }

        function cargarCategorias() {
            const info = window.flujoCaja?.obtenerInfo();
            
            if (!info || !info.categorias) {
                actualizarSelectCategorias(['Ventas', 'Servicios', 'Otros']);
                return;
            }
            
            actualizarSelectCategorias(info.categorias.ingresos);
        }

        function actualizarCategoriasSegunTipo() {
            const tipo = document.querySelector('input[name="tipo"]:checked').value;
            const info = window.flujoCaja.obtenerInfo();
            
            const categorias = tipo === 'ingreso' 
                ? info.categorias.ingresos 
                : info.categorias.gastos;
            
            actualizarSelectCategorias(categorias);
        }

        function actualizarSelectCategorias(categorias) {
            const select = document.getElementById('selectCategoria');
            select.innerHTML = '<option value="">Selecciona una categoría</option>';
            
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        function cargarBalance() {
            const balance = window.flujoCaja.calcularBalance();
            
            document.getElementById('balanceTotal').textContent = formatearMoneda(balance.balance);
            document.getElementById('totalIngresos').textContent = formatearMoneda(balance.ingresos);
            document.getElementById('totalGastos').textContent = formatearMoneda(balance.gastos);
            
            document.getElementById('cantidadIngresos').textContent = `${balance.cantidadIngresos} transacción${balance.cantidadIngresos !== 1 ? 'es' : ''}`;
            document.getElementById('cantidadGastos').textContent = `${balance.cantidadGastos} transacción${balance.cantidadGastos !== 1 ? 'es' : ''}`;
        }

        function cargarTransacciones(filtros = {}) {
            const transacciones = window.flujoCaja.obtenerTransacciones(filtros);
            const lista = document.getElementById('listaTransacciones');
            const sinDatos = document.getElementById('sinTransacciones');
            const totalBadge = document.getElementById('totalTransacciones');

            totalBadge.textContent = transacciones.length;

            if (transacciones.length === 0) {
                lista.style.display = 'none';
                sinDatos.style.display = 'flex';
                return;
            }

            lista.style.display = 'block';
            sinDatos.style.display = 'none';

            lista.innerHTML = transacciones.map(t => crearTarjetaTransaccion(t)).join('');
        }

        function crearTarjetaTransaccion(transaccion) {
            const fecha = new Date(transaccion.fecha);
            const esIngreso = transaccion.tipo === 'ingreso';
            
            return `
                <div class="transaccion-card ${transaccion.tipo}">
                    <div class="transaccion-icono ${transaccion.tipo}">
                        <i class="fas fa-arrow-${esIngreso ? 'up' : 'down'}"></i>
                    </div>
                    <div class="transaccion-info">
                        <div class="transaccion-descripcion">${transaccion.descripcion || transaccion.categoria}</div>
                        <div class="transaccion-detalles">
                            <span class="transaccion-categoria">${transaccion.categoria}</span>
                            <span class="transaccion-fecha">${fecha.toLocaleDateString('es-PE')}</span>
                        </div>
                    </div>
                    <div class="transaccion-monto ${transaccion.tipo}">
                        ${esIngreso ? '+' : '-'} ${formatearMoneda(transaccion.monto)}
                    </div>
                    <div class="transaccion-acciones">
                        <button class="btn-icono" onclick="editarTransaccion('${transaccion.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icono" onclick="eliminarTransaccion('${transaccion.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN'
            }).format(valor);
        }

        // ═══════════════════════════════════════════════════════════════
        // CONFIGURACIÓN DE EVENTOS
        // ═══════════════════════════════════════════════════════════════
        function configurarEventos() {
            console.log('⚙️ Configurando eventos...');
            
            document.getElementById('btnNuevaTransaccion')?.addEventListener('click', abrirModalTransaccion);
            document.getElementById('btnPrimeraTransaccion')?.addEventListener('click', abrirModalTransaccion);
            document.getElementById('btnCerrarModal')?.addEventListener('click', cerrarModalTransaccion);
            document.getElementById('btnCancelarModal')?.addEventListener('click', cerrarModalTransaccion);
            document.getElementById('btnGuardarTransaccion')?.addEventListener('click', guardarTransaccion);

            document.querySelectorAll('input[name="tipo"]').forEach(radio => {
                radio.addEventListener('change', actualizarCategoriasSegunTipo);
            });

            document.addEventListener('grizalumTransaccionAgregada', () => {
                cargarBalance();
                cargarTransacciones();
            });

            document.addEventListener('grizalumTransaccionEditada', () => {
                cargarBalance();
                cargarTransacciones();
            });

            document.addEventListener('grizalumTransaccionEliminada', () => {
                cargarBalance();
                cargarTransacciones();
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') cerrarModalTransaccion();
            });
            
            document.getElementById('modalTransaccion')?.addEventListener('click', (e) => {
                if (e.target.id === 'modalTransaccion') cerrarModalTransaccion();
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // INICIALIZACIÓN
        // ═══════════════════════════════════════════════════════════════
        function inicializarFlujoCaja() {
            console.log('🚀 Inicializando...');
            
            document.getElementById('inputFecha').valueAsDate = new Date();
            configurarEventos();
            
            if (!window.flujoCaja) {
                console.warn('⚠️ Esperando módulo...');
                let intentos = 0;
                const esperar = setInterval(() => {
                    intentos++;
                    if (window.flujoCaja) {
                        clearInterval(esperar);
                        cargarDatos();
                    } else if (intentos > 10) {
                        clearInterval(esperar);
                        console.error('❌ Módulo no disponible');
                    }
                }, 500);
                return;
            }

            cargarDatos();
        }

        function cargarDatos() {
            console.log('📊 Cargando datos...');
            cargarNivel();
            cargarCategorias();
            cargarBalance();
            cargarTransacciones();
            console.log('✅ Listo');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarFlujoCaja);
        } else {
            inicializarFlujoCaja();
        }
    </script>

</body>
</html>

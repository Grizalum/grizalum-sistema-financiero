<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRIZALUM - Sistema Financiero Empresarial Premium</title>
    
    <!-- Meta Tags SEO -->
    <meta name="description" content="Sistema financiero empresarial premium con IA integrada para empresas peruanas. Dashboard ejecutivo, flujo de caja, análisis predictivo.">
    <meta name="keywords" content="sistema financiero, empresas peru, contabilidad, flujo de caja, dashboard, IA">
    <meta name="author" content="GRIZALUM">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="src/assets/images/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    
    <!-- Chart.js -->
  <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    
    <!-- ========== AGREGAR ESTAS LÍNEAS NUEVAS ========== -->
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <!-- META TAGS PARA PWA -->
    <meta name="application-name" content="GRIZALUM">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GRIZALUM">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#d4af37">
    <meta name="theme-color" content="#d4af37">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- ICONOS ADICIONALES -->
    <link rel="icon" type="image/png" sizes="32x32" href="src/assets/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="src/assets/images/icon-16x16.png">
    <link rel="apple-touch-icon" href="src/assets/images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="src/assets/images/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="src/assets/images/icon-180x180.png">
    
    <!-- Microsoft tiles -->
    <meta name="msapplication-TileImage" content="src/assets/images/icon-144x144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- ========== FIN DE LÍNEAS NUEVAS ========== -->
    
    <!-- Styles - RUTAS DESDE LA RAÍZ -->
    <link rel="stylesheet" href="src/assets/css/styles.css">
    <link rel="stylesheet" href="src/assets/css/responsive.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="brand-icon loading-logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <h1>GRIZALUM</h1>
            <p>Cargando sistema financiero...</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="company-brand">
                    <div class="brand-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="brand-text">
                        <h1>GRIZALUM</h1>
                        <p>Control Financiero</p>
                    </div>
                </div>
                
                <div class="financial-summary">
                    <div class="summary-item">
                        <span class="summary-label">Flujo de Caja</span>
                        <span class="summary-value" id="sidebarCashFlow">S/. 24,500</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ingresos Mes</span>
                        <span class="summary-value" id="sidebarRevenue">S/. 45,200</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Gastos Mes</span>
                        <span class="summary-value" id="sidebarExpenses">S/. 28,700</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Utilidad Neta</span>
                        <span class="summary-value" id="sidebarProfit">S/. 16,500</span>
                    </div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-chart-bar"></i>
                        Panel Principal
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('cash-flow')">
                            <i class="nav-icon fas fa-water"></i>
                            <span>Flujo de Caja</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-calculator"></i>
                        Contabilidad
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('income-statement')">
                            <i class="nav-icon fas fa-chart-pie"></i>
                            <span>Estado de Resultados</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('balance-sheet')">
                            <i class="nav-icon fas fa-balance-scale"></i>
                            <span>Balance General</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('accounts-receivable')">
                            <i class="nav-icon fas fa-coins"></i>
                            <span>Cuentas por Cobrar</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('accounts-payable')">
                            <i class="nav-icon fas fa-credit-card"></i>
                            <span>Cuentas por Pagar</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-warehouse"></i>
                        Operaciones
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('inventory')">
                            <i class="nav-icon fas fa-boxes"></i>
                            <span>Inventario</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('sales')">
                            <i class="nav-icon fas fa-shopping-cart"></i>
                            <span>Ventas</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('purchases')">
                            <i class="nav-icon fas fa-truck"></i>
                            <span>Compras</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-chart-area"></i>
                        Análisis
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('financial-analysis')">
                            <i class="nav-icon fas fa-magnifying-glass-chart"></i>
                            <span>Análisis Financiero</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('reports')">
                            <i class="nav-icon fas fa-file-alt"></i>
                            <span>Reportes</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="executive-header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="page-header">
                    <div>
                        <h1 class="page-title" id="pageTitle">Dashboard Ejecutivo</h1>
                        <p class="page-subtitle" id="pageSubtitle">Resumen financiero en tiempo real</p>
                        <div class="ai-insights">
                            <i class="fas fa-brain"></i>
                            <span>IA predice crecimiento del 15% este trimestre</span>
                        </div>
                    </div>
                </div>

                <div class="header-controls">
                    <div class="time-period-selector">
                        <button class="period-btn active" onclick="changePeriod('hoy', this)">Hoy</button>
                        <button class="period-btn" onclick="changePeriod('semana', this)">Semana</button>
                        <button class="period-btn" onclick="changePeriod('mes', this)">Mes</button>
                        <button class="period-btn" onclick="changePeriod('trimestre', this)">Trimestre</button>
                        <button class="period-btn" onclick="changePeriod('año', this)">Año</button>
                    </div>

                    <button class="notification-center" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>

                    <div class="executive-profile">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">Admin Usuario</div>
                            <div class="profile-role">Gerente General</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- DASHBOARD SECTION -->
                <section class="page-section active" id="dashboard">
                    <!-- REAL-TIME INDICATOR -->
                    <div style="margin-bottom: 1rem;">
                        <div class="real-time-indicator">
                            <div class="real-time-dot"></div>
                            <span>Datos actualizados hace 2 minutos</span>
                        </div>
                    </div>

                    <!-- KPI CARDS -->
                    <div class="kpi-grid">
                        <div class="kpi-card cash-flow profit-glow micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Flujo de Caja Actual</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-profit)">
                                    <i class="fas fa-water"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 24,500</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+18.5%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA predice:</strong> Flujo positivo sostenido próximos 3 meses
                            </div>
                        </div>

                        <div class="kpi-card revenue micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Ingresos Totales</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-blue)">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 45,200</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+12.3%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA sugiere:</strong> Meta agosto: S/. 52,000 (alcanzable)
                            </div>
                        </div>

                        <div class="kpi-card expenses micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Gastos Operativos</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-loss)">
                                    <i class="fas fa-chart-line-down"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 28,700</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>-5.2%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA alerta:</strong> Gasto en marketing puede optimizarse 15%
                            </div>
                        </div>

                        <div class="kpi-card profit gold-glow micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Utilidad Neta</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-gold)">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 16,500</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+28.7%</span>
                                </div>
                                <span>Margen: 36.5%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 73%" title="Meta anual: 73% completado"></div>
                            </div>
                        </div>
                    </div>

                    <!-- CHARTS SECTION -->
                    <div class="charts-section">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-chart-line"></i>
                                    Tendencia de Ingresos vs Gastos
                                </h3>
                                <div class="real-time-indicator">
                                    <div class="real-time-dot"></div>
                                    <span>Tiempo Real</span>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-chart-pie"></i>
                                    Distribución de Gastos
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-water"></i>
                                    Flujo de Caja Proyectado
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-coins"></i>
                                    Aging Cuentas por Cobrar
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="agingChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- AI INSIGHTS SECTION -->
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-brain"></i>
                                Insights de Inteligencia Artificial
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-primary btn-sm" onclick="generateAIReport()">
                                    <i class="fas fa-magic"></i>
                                    Generar Análisis IA
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                <h4 style="color: var(--indigo); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                                    Predicción de Ventas
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    Basado en datos históricos y tendencias actuales, las ventas de agosto podrían alcanzar <strong>S/. 52,000</strong> (+15% vs julio). 
                                    Recomendación: Incrementar inventario de productos estrella.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(5, 150, 105, 0.2);">
                                <h4 style="color: var(--profit); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-coins" style="margin-right: 0.5rem;"></i>
                                    Optimización de Cobranzas
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    <strong>3 clientes</strong> están cerca del límite de crédito. Contactar esta semana podría recuperar 
                                    <strong>S/. 15,200</strong> y mejorar el flujo de caja en 8 días.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(217, 119, 6, 0.2);">
                                <h4 style="color: var(--warning); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                    Alerta de Inventario
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    El producto "Material Premium" se agotará en <strong>12 días</strong> al ritmo actual. 
                                    Generar orden de compra por <strong>S/. 8,500</strong> para evitar quiebre de stock.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(184, 115, 51, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <h4 style="color: var(--peru-gold); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                                    Oportunidad de Ahorro
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    Renegociar contrato con proveedor principal podría ahorrar <strong>S/. 3,200/mes</strong> 
                                    (11% del gasto actual). ROI estimado: 340% anual.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CASH FLOW SECTION -->
                <section class="page-section" id="cash-flow">
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-water"></i>
                                Gestión de Flujo de Caja
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="exportCashFlow()">
                                    <i class="fas fa-download"></i>
                                    Exportar
                                </button>
                                <button class="btn btn-primary" onclick="showCashFlowForm()">
                                    <i class="fas fa-plus"></i>
                                    Nueva Transacción
                                </button>
                            </div>
                        </div>

                        <!-- CASH FLOW TABLE -->
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripción</th>
                                    <th>Categoría</th>
                                    <th>Tipo</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Saldo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cashFlowTableBody">
                                <tr>
                                    <td>17/07/2025</td>
                                    <td>Venta productos julio</td>
                                    <td>Ventas</td>
                                    <td>Operativo</td>
                                    <td style="color: var(--profit); font-weight: 700;">+S/. 15,200</td>
                                    <td>-</td>
                                    <td style="color: var(--profit); font-weight: 700;">S/. 24,500</td>
                                    <td>
                                        <button class="btn btn-sm btn-neutral micro-interaction" onclick="editTransaction(1)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- OTHER SECTIONS -->
                <section class="page-section" id="income-statement">
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-chart-pie"></i>
                                Estado de Resultados
                            </h2>
                        </div>
                        <div class="empty-state-executive">
                            <div class="empty-state-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3 class="empty-state-title">Módulo en Desarrollo</h3>
                            <p class="empty-state-subtitle">El Estado de Resultados estará disponible próximamente.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts - RUTAS DESDE LA RAÍZ -->
    <script src="src/assets/js/main.js"></script>
    <script src="src/assets/js/charts.js"></script>
    <script src="src/assets/js/ai.js"></script>
    
    <script>
    // REGISTRO DEL SERVICE WORKER Y PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async function() {
            try {
                // Registrar Service Worker
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });
                
                console.log('✅ GRIZALUM SW registrado:', registration.scope);
                
                // Manejar actualizaciones
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateAvailableNotification();
                        }
                    });
                });
                
                // Escuchar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', event => {
                    const { type, message } = event.data;
                    
                    switch (type) {
                        case 'OFFLINE_MODE':
                            showOfflineModeNotification(message);
                            break;
                        case 'CACHE_UPDATED':
                            showCacheUpdatedNotification();
                            break;
                    }
                });
                
            } catch (error) {
                console.error('❌ Error registrando Service Worker:', error);
            }
        });
    }

    // INSTALACIÓN DE PWA
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('💾 PWA instalable detectada');
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
    });

    // Mostrar prompt de instalación
    function showInstallPrompt() {
        const installBanner = document.createElement('div');
        installBanner.id = 'install-banner';
        installBanner.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            animation: slideInRight 0.5s ease;
            max-width: 350px;
        `;
        
        installBanner.innerHTML = `
            <i class="fas fa-download" style="font-size: 1.5rem;"></i>
            <div>
                <div style="margin-bottom: 0.5rem;">¡Instala GRIZALUM!</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Acceso rápido desde tu escritorio</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button id="install-yes" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">Instalar</button>
                <button id="install-no" style="
                    background: rgba(0,0,0,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">Después</button>
            </div>
        `;
        
        document.body.appendChild(installBanner);
        
        // Manejar clicks
        document.getElementById('install-yes').addEventListener('click', installPWA);
        document.getElementById('install-no').addEventListener('click', () => {
            installBanner.remove();
        });
        
        // Auto-hide después de 10 segundos
        setTimeout(() => {
            if (document.getElementById('install-banner')) {
                installBanner.remove();
            }
        }, 10000);
    }

    // Instalar PWA
    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('✅ PWA instalada exitosamente');
                showSuccessMessage('🎉 GRIZALUM instalado correctamente');
            }
            
            deferredPrompt = null;
            document.getElementById('install-banner')?.remove();
        }
    }

    // Detectar cuando la app fue instalada
    window.addEventListener('appinstalled', (evt) => {
        console.log('🎉 GRIZALUM PWA instalada');
        showSuccessMessage('¡Bienvenido a GRIZALUM instalado! 🚀');
    });

    // Notificaciones del sistema
    function showUpdateAvailableNotification() {
        const updateBanner = document.createElement('div');
        updateBanner.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            cursor: pointer;
        `;
        
        updateBanner.innerHTML = `
            <i class="fas fa-sync-alt"></i>
            <div>
                <div>Actualización disponible</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Click para actualizar</div>
            </div>
        `;
        
        updateBanner.addEventListener('click', () => {
            location.reload();
        });
        
        document.body.appendChild(updateBanner);
        
        setTimeout(() => updateBanner.remove(), 8000);
    }

    function showOfflineModeNotification(message) {
        const offlineBanner = document.createElement('div');
        offlineBanner.style.cssText = `
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            text-align: center;
            font-weight: 600;
        `;
        
        offlineBanner.innerHTML = `
            <i class="fas fa-wifi-slash" style="margin-right: 0.5rem;"></i>
            ${message} - Trabajando en modo offline
        `;
        
        document.body.appendChild(offlineBanner);
        
        setTimeout(() => offlineBanner.remove(), 5000);
    }

    // GESTIÓN DE CONEXIÓN
    window.addEventListener('online', () => {
        console.log('🌐 Conexión restaurada');
        showSuccessMessage('🌐 Conexión a internet restaurada');
        
        // Sincronizar datos pendientes
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'SYNC_PENDING_DATA'
            });
        }
    });

    window.addEventListener('offline', () => {
        console.log('📱 Trabajando offline');
        showOfflineModeNotification('Sin conexión a internet');
    });

    // CONFIGURACIÓN DE ACCESOS DIRECTOS DE TECLADO PARA PWA
    document.addEventListener('keydown', (event) => {
        // Solo funcionar si no estamos escribiendo en un input
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
            return;
        }
        
        // Ctrl/Cmd + Shift + D = Dashboard
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'D') {
            event.preventDefault();
            showSection('dashboard');
        }
        
        // Ctrl/Cmd + Shift + F = Flujo de Caja
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'F') {
            event.preventDefault();
            showSection('cash-flow');
        }
        
        // Ctrl/Cmd + Shift + N = Nueva Transacción
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'N') {
            event.preventDefault();
            showCashFlowForm();
        }
        
        // Ctrl/Cmd + Shift + I = Instalar PWA
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'I') {
            event.preventDefault();
            if (deferredPrompt) {
                installPWA();
            }
        }
    });

    // MÉTRICAS DE RENDIMIENTO
    function trackPerformanceMetrics() {
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const metrics = {
                        loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                        domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                        firstPaint: performance.getEntriesByType('paint')[0]?.startTime || 0,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('📊 Métricas de rendimiento:', metrics);
                }, 0);
            });
        }
    }

    // FUNCIONES PARA GESTIONAR CACHÉ
    async function clearAppCache() {
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            showSuccessMessage('🗑️ Caché limpiado correctamente');
            location.reload();
        }
    }

    async function getCacheSize() {
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            let totalSize = 0;
            
            for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName);
                const keys = await cache.keys();
                totalSize += keys.length;
            }
            
            return totalSize;
        }
        return 0;
    }

    // INICIALIZACIÓN DE PWA
    function initializePWA() {
        trackPerformanceMetrics();
        
        // Mostrar información de la app si es la primera visita
        if (!localStorage.getItem('grizalum-first-visit')) {
            setTimeout(() => {
                showWelcomeMessage();
                localStorage.setItem('grizalum-first-visit', 'true');
            }, 3000);
        }
        
        console.log('🚀 PWA GRIZALUM inicializada correctamente');
    }

    function showWelcomeMessage() {
        const welcomeModal = document.createElement('div');
        welcomeModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        `;
        
        welcomeModal.innerHTML = `
            <div style="
                background: white;
                padding: 3rem;
                border-radius: 24px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
            ">
                <div style="
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 2rem;
                    font-size: 2rem;
                    color: white;
                ">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h2 style="margin-bottom: 1rem; color: #1e293b; font-size: 1.5rem;">¡Bienvenido a GRIZALUM!</h2>
                <p style="color: #64748b; margin-bottom: 2rem; line-height: 1.6;">
                    Sistema financiero empresarial premium diseñado específicamente para empresas peruanas. 
                    Gestiona tu flujo de caja, análisis predictivo con IA y contabilidad completa.
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button id="welcome-start" style="
                        background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 12px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Comenzar</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(welcomeModal);
        
        document.getElementById('welcome-start').addEventListener('click', () => {
            welcomeModal.remove();
        });
    }

    // Inicializar PWA cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePWA);
    } else {
        initializePWA();
    }

    // Estilos adicionales para PWA
    const pwaStyles = document.createElement('style');
    pwaStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Estilos para cuando la app está instalada */
    @media (display-mode: standalone) {
        body {
            user-select: none;
            -webkit-user-select: none;
        }
        
        .pwa-only {
            display: block !important;
        }
        
        .browser-only {
            display: none !important;
        }
    }

    /* Optimizaciones para pantallas táctiles */
    @media (pointer: coarse) {
        .btn, .nav-link, .kpi-card {
            min-height: 44px;
        }
        
        .form-input {
            font-size: 16px; /* Previene zoom en iOS */
        }
    }

    /* Animaciones optimizadas para PWA */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
    `;
    document.head.appendChild(pwaStyles);
    </script>
</body>
</html>

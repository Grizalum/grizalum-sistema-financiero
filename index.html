<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRIZALUM - Sistema Financiero Empresarial Premium</title>
    
    <!-- Meta Tags SEO -->
    <meta name="description" content="Sistema financiero empresarial premium con IA integrada para empresas peruanas. Dashboard ejecutivo, flujo de caja, an√°lisis predictivo.">
    <meta name="keywords" content="sistema financiero, empresas peru, contabilidad, flujo de caja, dashboard, IA">
    <meta name="author" content="GRIZALUM">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="src/assets/images/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    
    <!-- Chart.js -->
  <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    
    <!-- ========== AGREGAR ESTAS L√çNEAS NUEVAS ========== -->
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <!-- META TAGS PARA PWA -->
    <meta name="application-name" content="GRIZALUM">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GRIZALUM">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#d4af37">
    <meta name="theme-color" content="#d4af37">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- ICONOS ADICIONALES -->
    <link rel="icon" type="image/png" sizes="32x32" href="src/assets/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="src/assets/images/icon-16x16.png">
    <link rel="apple-touch-icon" href="src/assets/images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="src/assets/images/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="src/assets/images/icon-180x180.png">
    
    <!-- Microsoft tiles -->
    <meta name="msapplication-TileImage" content="src/assets/images/icon-144x144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- ========== FIN DE L√çNEAS NUEVAS ========== -->
    
    <!-- Styles - RUTAS DESDE LA RA√çZ -->
    <link rel="stylesheet" href="src/assets/css/styles.css">
    <link rel="stylesheet" href="src/assets/css/responsive.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="brand-icon loading-logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <h1>GRIZALUM</h1>
            <p>Cargando sistema financiero...</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="company-brand">
                    <div class="brand-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="brand-text">
                        <h1>GRIZALUM</h1>
                        <p>Control Financiero</p>
                    </div>
                </div>
                
                <div class="financial-summary">
                    <div class="summary-item">
                        <span class="summary-label">Flujo de Caja</span>
                        <span class="summary-value" id="sidebarCashFlow">S/. 24,500</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ingresos Mes</span>
                        <span class="summary-value" id="sidebarRevenue">S/. 45,200</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Gastos Mes</span>
                        <span class="summary-value" id="sidebarExpenses">S/. 28,700</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Utilidad Neta</span>
                        <span class="summary-value" id="sidebarProfit">S/. 16,500</span>
                    </div>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-chart-bar"></i>
                        Panel Principal
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('cash-flow')">
                            <i class="nav-icon fas fa-water"></i>
                            <span>Flujo de Caja</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-calculator"></i>
                        Contabilidad
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('income-statement')">
                            <i class="nav-icon fas fa-chart-pie"></i>
                            <span>Estado de Resultados</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('balance-sheet')">
                            <i class="nav-icon fas fa-balance-scale"></i>
                            <span>Balance General</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('accounts-receivable')">
                            <i class="nav-icon fas fa-coins"></i>
                            <span>Cuentas por Cobrar</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('accounts-payable')">
                            <i class="nav-icon fas fa-credit-card"></i>
                            <span>Cuentas por Pagar</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-warehouse"></i>
                        Operaciones
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('inventory')">
                            <i class="nav-icon fas fa-boxes"></i>
                            <span>Inventario</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('sales')">
                            <i class="nav-icon fas fa-shopping-cart"></i>
                            <span>Ventas</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('purchases')">
                            <i class="nav-icon fas fa-truck"></i>
                            <span>Compras</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-chart-area"></i>
                        An√°lisis
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('financial-analysis')">
                            <i class="nav-icon fas fa-magnifying-glass-chart"></i>
                            <span>An√°lisis Financiero</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('reports')">
                            <i class="nav-icon fas fa-file-alt"></i>
                            <span>Reportes</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="executive-header">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="page-header">
                    <div>
                        <h1 class="page-title" id="pageTitle">Dashboard Ejecutivo</h1>
                        <p class="page-subtitle" id="pageSubtitle">Resumen financiero en tiempo real</p>
                        <div class="ai-insights">
                            <i class="fas fa-brain"></i>
                            <span>IA predice crecimiento del 15% este trimestre</span>
                        </div>
                    </div>
                </div>

                <div class="header-controls">
                    <div class="time-period-selector">
                        <button class="period-btn active" onclick="changePeriod('hoy', this)">Hoy</button>
                        <button class="period-btn" onclick="changePeriod('semana', this)">Semana</button>
                        <button class="period-btn" onclick="changePeriod('mes', this)">Mes</button>
                        <button class="period-btn" onclick="changePeriod('trimestre', this)">Trimestre</button>
                        <button class="period-btn" onclick="changePeriod('a√±o', this)">A√±o</button>
                    </div>

                    <button class="notification-center" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>

<!-- SELECTOR DE EMPRESAS - REEMPLAZAR LA SECCI√ìN executive-profile -->
<div class="company-selector" id="companySelector">
    <div class="selected-company" onclick="toggleCompanyDropdown()">
        <div class="company-info">
            <div class="company-icon" id="currentCompanyIcon">üî•</div>
            <div class="company-details">
                <div class="company-name" id="currentCompanyName">Fundici√≥n Laguna</div>
                <div class="company-status" id="currentCompanyStatus">üü¢ Operativo</div>
            </div>
        </div>
        <div class="dropdown-arrow">
            <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        </div>
    </div>
    
    <div class="company-dropdown" id="companyDropdown">
        <div class="dropdown-header">
            <h4>üè¢ Empresas GRIZALUM</h4>
            <button class="btn-add-company" onclick="showAddCompanyWizard()">
                <i class="fas fa-plus"></i>
                Agregar Nueva
            </button>
        </div>
        
        <div class="companies-list">
            <div class="company-item active" data-company="fundicion-laguna" onclick="selectCompany('fundicion-laguna')">
                <div class="company-item-icon">üî•</div>
                <div class="company-item-info">
                    <div class="company-item-name">Fundici√≥n Laguna</div>
                    <div class="company-item-stats">Flujo: S/. 24,500</div>
                </div>
                <div class="company-item-status">üü¢</div>
            </div>
            
            <div class="company-item" data-company="fundicion-joel" onclick="selectCompany('fundicion-joel')">
                <div class="company-item-icon">üî•</div>
                <div class="company-item-info">
                    <div class="company-item-name">Fundici√≥n Joel</div>
                    <div class="company-item-stats">Flujo: S/. 18,300</div>
                </div>
                <div class="company-item-status">üü¢</div>
            </div>
            
            <div class="company-item" data-company="avicola-san-juan" onclick="selectCompany('avicola-san-juan')">
                <div class="company-item-icon">üêî</div>
                <div class="company-item-info">
                    <div class="company-item-name">Av√≠cola San Juan</div>
                    <div class="company-item-stats">Flujo: S/. 32,100</div>
                </div>
                <div class="company-item-status">üü¢</div>
            </div>
            
            <div class="company-item" data-company="bodega-central" onclick="selectCompany('bodega-central')">
                <div class="company-item-icon">üè™</div>
                <div class="company-item-info">
                    <div class="company-item-name">Bodega Central</div>
                    <div class="company-item-stats">Flujo: S/. 15,800</div>
                </div>
                <div class="company-item-status">üü°</div>
            </div>
            
            <div class="company-item" data-company="importaciones-gz" onclick="selectCompany('importaciones-gz')">
                <div class="company-item-icon">üì¶</div>
                <div class="company-item-info">
                    <div class="company-item-name">Importaciones GZ</div>
                    <div class="company-item-stats">Flujo: S/. 45,200</div>
                </div>
                <div class="company-item-status">üü¢</div>
            </div>
        </div>
        
        <div class="dropdown-footer">
            <div class="total-companies">
                <strong>üìä Total Holding: S/. 135,900</strong>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS CSS PARA EL SELECTOR -->
<style>
.company-selector {
    position: relative;
    min-width: 280px;
}

.selected-company {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(184, 115, 51, 0.1) 100%);
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 16px;
    padding: 1rem 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.selected-company:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(212, 175, 55, 0.2);
    border-color: rgba(212, 175, 55, 0.5);
}

.company-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.company-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.company-details {
    display: flex;
    flex-direction: column;
}

.company-name {
    font-size: 1rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
}

.company-status {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--gray-600);
}

.dropdown-arrow {
    color: var(--gray-600);
    transition: transform 0.3s ease;
}

.dropdown-arrow.rotate {
    transform: rotate(180deg);
}

.company-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid var(--gray-200);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
}

.company-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dropdown-header h4 {
    margin: 0;
    color: var(--gray-800);
    font-size: 1.1rem;
    font-weight: 700;
}

.btn-add-company {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-add-company:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.companies-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0.5rem;
}

.company-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0.25rem;
}

.company-item:hover {
    background: var(--gray-50);
    transform: translateX(4px);
}

.company-item.active {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(184, 115, 51, 0.1) 100%);
    border: 1px solid rgba(212, 175, 55, 0.3);
}

.company-item-icon {
    width: 40px;
    height: 40px;
    background: var(--gray-100);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.company-item-info {
    flex: 1;
}

.company-item-name {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
}

.company-item-stats {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.company-item-status {
    font-size: 1rem;
}

.dropdown-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    background: var(--gray-50);
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    text-align: center;
}

.dropdown-footer strong {
    color: var(--gray-800);
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
    .company-selector {
        min-width: 250px;
    }
    
    .company-dropdown {
        width: 300px;
        right: -50px;
    }
}
</style>

<!-- JAVASCRIPT PARA FUNCIONALIDAD -->
<script>
// FUNCIONES DEL SELECTOR DE EMPRESAS
function toggleCompanyDropdown() {
    const dropdown = document.getElementById('companyDropdown');
    const arrow = document.getElementById('dropdownArrow');
    
    dropdown.classList.toggle('show');
    arrow.classList.toggle('rotate');
}

function selectCompany(companyId) {
    // Actualizar empresa seleccionada
    updateSelectedCompany(companyId);
    
    // Actualizar datos de la empresa
    updateCompanyData(companyId);
    
    // Cerrar dropdown
    toggleCompanyDropdown();
    
    // Actualizar tema de IA
    const companies = getCompaniesData();
    const company = companies[companyId];
    if (company && company.theme) {
        updateAITheme(company.theme);
    }
    
    // Mostrar mensaje de cambio
    showNotification(`üè¢ Cambiado a ${getCompanyName(companyId)}`, 'success');
}

function updateSelectedCompany(companyId) {
    const companies = getCompaniesData();
    const company = companies[companyId];
    
    if (company) {
        document.getElementById('currentCompanyIcon').textContent = company.icon;
        document.getElementById('currentCompanyName').textContent = company.name;
        document.getElementById('currentCompanyStatus').textContent = `üü¢ ${company.status}`;
        
        // Actualizar clase activa
        document.querySelectorAll('.company-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-company="${companyId}"]`).classList.add('active');
    }
}

function updateCompanyData(companyId) {
    const companies = getCompaniesData();
    const company = companies[companyId];
    
    if (company) {
        // Actualizar KPIs del dashboard
        updateKPIs(company.data);
        
        // Actualizar sidebar
        updateSidebar(company.data);
        
        // Actualizar tema de colores
        updateCompanyTheme(company.theme);
        
        console.log(`üìä Datos actualizados para: ${company.name}`);
    }
}

function getCompaniesData() {
    return {
        'fundicion-laguna': {
            name: 'Fundici√≥n Laguna',
            icon: 'üî•',
            status: 'Operativo',
            theme: { primary: '#dc2626', secondary: '#ea580c' },
            data: {
                cashFlow: 24500,
                revenue: 45200,
                expenses: 28700,
                profit: 16500
            }
        },
        'fundicion-joel': {
            name: 'Fundici√≥n Joel',
            icon: 'üî•',
            status: 'Operativo',
            theme: { primary: '#ea580c', secondary: '#f97316' },
            data: {
                cashFlow: 18300,
                revenue: 32100,
                expenses: 21800,
                profit: 10300
            }
        },
        'avicola-san-juan': {
            name: 'Av√≠cola San Juan',
            icon: 'üêî',
            status: 'Operativo',
            theme: { primary: '#059669', secondary: '#10b981' },
            data: {
                cashFlow: 32100,
                revenue: 58300,
                expenses: 41200,
                profit: 17100
            }
        },
        'bodega-central': {
            name: 'Bodega Central',
            icon: 'üè™',
            status: 'Regular',
            theme: { primary: '#3b82f6', secondary: '#60a5fa' },
            data: {
                cashFlow: 15800,
                revenue: 28500,
                expenses: 19700,
                profit: 8800
            }
        },
        'importaciones-gz': {
            name: 'Importaciones GZ',
            icon: 'üì¶',
            status: 'Operativo',
            theme: { primary: '#8b5cf6', secondary: '#a78bfa' },
            data: {
                cashFlow: 45200,
                revenue: 72800,
                expenses: 48600,
                profit: 24200
            }
        }
    };
}

function updateKPIs(data) {
    // Actualizar valores en las tarjetas KPI
    const kpiValues = document.querySelectorAll('.kpi-value-animation');
    if (kpiValues.length >= 4) {
        kpiValues[0].textContent = `S/. ${data.cashFlow.toLocaleString()}`;
        kpiValues[1].textContent = `S/. ${data.revenue.toLocaleString()}`;
        kpiValues[2].textContent = `S/. ${data.expenses.toLocaleString()}`;
        kpiValues[3].textContent = `S/. ${data.profit.toLocaleString()}`;
    }
}

function updateSidebar(data) {
    // Actualizar valores en el sidebar
    const elements = {
        'sidebarCashFlow': data.cashFlow,
        'sidebarRevenue': data.revenue,
        'sidebarExpenses': data.expenses,
        'sidebarProfit': data.profit
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = `S/. ${value.toLocaleString()}`;
        }
    });
}

function updateCompanyTheme(theme) {
    // Cambiar colores del tema seg√∫n la empresa
    document.documentElement.style.setProperty('--company-primary', theme.primary);
    document.documentElement.style.setProperty('--company-secondary', theme.secondary);
 }
    
function updateAITheme(theme) {
    const aiButton = document.getElementById('aiAssistantButton');
    const aiHeader = document.querySelector('.ai-panel-header');
    
    if (aiButton && theme) {
        aiButton.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
    }
    
    if (aiHeader && theme) {
        aiHeader.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
   }
  }  

function getCompanyName(companyId) {
    const companies = getCompaniesData();
    return companies[companyId]?.name || 'Empresa';
}

function showAddCompanyWizard() {
    alert('üöÄ Wizard para agregar empresa pr√≥ximamente...');
    toggleCompanyDropdown();
}

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', function(event) {
    const selector = document.getElementById('companySelector');
    const dropdown = document.getElementById('companyDropdown');
    
    if (selector && !selector.contains(event.target)) {
        dropdown.classList.remove('show');
        document.getElementById('dropdownArrow').classList.remove('rotate');
    }
});

console.log('üè¢ Selector de empresas GRIZALUM cargado');
</script>
<!-- AGREGAR DESPU√âS DEL SCRIPT ANTERIOR -->

<!-- MODAL PARA GESTI√ìN DE EMPRESAS -->
<div id="companyManagementModal" class="management-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚öôÔ∏è Gesti√≥n de Empresas</h3>
            <button class="close-modal" onclick="closeManagementModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="companies-management-list" id="managementList">
                <!-- Se llena din√°micamente -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-neutral" onclick="closeManagementModal()">
                Cerrar
            </button>
        </div>
    </div>
</div>

<!-- MODAL PARA EDITAR EMPRESA -->
<div id="editCompanyModal" class="management-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Empresa</h3>
            <button class="close-modal" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Nombre de la Empresa</label>
                <input type="text" id="editCompanyName" class="form-input" placeholder="Ej: Import LM">
            </div>
            
            <div class="form-group">
                <label class="form-label">Icono</label>
                <div class="icon-selector">
                    <div class="icon-option" data-icon="üî•" onclick="selectIcon('üî•')">üî•</div>
                    <div class="icon-option" data-icon="üêî" onclick="selectIcon('üêî')">üêî</div>
                    <div class="icon-option" data-icon="üè™" onclick="selectIcon('üè™')">üè™</div>
                    <div class="icon-option" data-icon="üì¶" onclick="selectIcon('üì¶')">üì¶</div>
                    <div class="icon-option" data-icon="üè≠" onclick="selectIcon('üè≠')">üè≠</div>
                    <div class="icon-option" data-icon="üöõ" onclick="selectIcon('üöõ')">üöõ</div>
                    <div class="icon-option" data-icon="üíº" onclick="selectIcon('üíº')">üíº</div>
                    <div class="icon-option" data-icon="üè¢" onclick="selectIcon('üè¢')">üè¢</div>
                </div>
                <input type="hidden" id="editCompanyIcon" value="üî•">
            </div>
            
            <div class="form-group">
                <label class="form-label">Estado</label>
                <select id="editCompanyStatus" class="form-input">
                    <option value="Operativo">üü¢ Operativo</option>
                    <option value="Regular">üü° Regular</option>
                    <option value="Mantenimiento">üîµ Mantenimiento</option>
                    <option value="Cerrado">üî¥ Cerrado</option>
                </select>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-success" onclick="saveCompanyChanges()">
                <i class="fas fa-save"></i>
                Guardar Cambios
            </button>
            <button class="btn btn-neutral" onclick="closeEditModal()">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- ESTILOS PARA MODALES -->
<style>
.management-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem;
    border-bottom: 1px solid var(--gray-200);
}

.modal-header h3 {
    margin: 0;
    color: var(--gray-800);
    font-weight: 700;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-500);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.close-modal:hover {
    background: var(--gray-100);
    color: var(--gray-700);
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.management-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.management-item:hover {
    border-color: var(--peru-gold);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.management-item-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.management-item-icon {
    width: 50px;
    height: 50px;
    background: var(--gray-100);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.management-item-details h4 {
    margin: 0 0 0.25rem 0;
    color: var(--gray-800);
    font-weight: 600;
}

.management-item-details p {
    margin: 0;
    color: var(--gray-600);
    font-size: 0.9rem;
}

.management-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-action {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-edit {
    background: var(--gradient-blue);
    color: white;
}

.btn-delete {
    background: var(--gradient-loss);
    color: white;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.icon-selector {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.icon-option {
    width: 50px;
    height: 50px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.icon-option:hover {
    border-color: var(--peru-gold);
    background: rgba(212, 175, 55, 0.1);
}

.icon-option.selected {
    border-color: var(--peru-gold);
    background: rgba(212, 175, 55, 0.2);
}

/* Animaciones */
.management-modal.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

<!-- JAVASCRIPT PARA GESTI√ìN DE EMPRESAS -->
<script>
let currentEditingCompany = null;

// ABRIR MODAL DE GESTI√ìN
function openCompanyManagement() {
    loadManagementList();
    document.getElementById('companyManagementModal').classList.add('show');
    document.getElementById('companyManagementModal').style.display = 'block';
}

// CERRAR MODAL DE GESTI√ìN
function closeManagementModal() {
    document.getElementById('companyManagementModal').style.display = 'none';
    document.getElementById('companyManagementModal').classList.remove('show');
}

// CARGAR LISTA DE EMPRESAS PARA GESTI√ìN
function loadManagementList() {
    const companies = getCompaniesData();
    const listContainer = document.getElementById('managementList');
    
    listContainer.innerHTML = '';
    
    Object.entries(companies).forEach(([id, company]) => {
        const item = document.createElement('div');
        item.className = 'management-item';
        item.innerHTML = `
            <div class="management-item-info">
                <div class="management-item-icon">${company.icon}</div>
                <div class="management-item-details">
                    <h4>${company.name}</h4>
                    <p>Estado: ${company.status} | Flujo: S/. ${company.data.cashFlow.toLocaleString()}</p>
                </div>
            </div>
            <div class="management-actions">
                <button class="btn-action btn-edit" onclick="editCompany('${id}')">
                    <i class="fas fa-edit"></i>
                    Editar
                </button>
                <button class="btn-action btn-delete" onclick="deleteCompany('${id}')">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
            </div>
        `;
        listContainer.appendChild(item);
    });
}

// EDITAR EMPRESA
function editCompany(companyId) {
    currentEditingCompany = companyId;
    const companies = getCompaniesData();
    const company = companies[companyId];
    
    if (company) {
        document.getElementById('editCompanyName').value = company.name;
        document.getElementById('editCompanyIcon').value = company.icon;
        document.getElementById('editCompanyStatus').value = company.status;
        
        // Marcar icono seleccionado
        document.querySelectorAll('.icon-option').forEach(option => {
            option.classList.remove('selected');
            if (option.dataset.icon === company.icon) {
                option.classList.add('selected');
            }
        });
        
        closeManagementModal();
        document.getElementById('editCompanyModal').style.display = 'block';
        document.getElementById('editCompanyModal').classList.add('show');
    }
}

// SELECCIONAR ICONO
function selectIcon(icon) {
    document.querySelectorAll('.icon-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    event.target.classList.add('selected');
    document.getElementById('editCompanyIcon').value = icon;
}

// GUARDAR CAMBIOS DE EMPRESA
function saveCompanyChanges() {
    if (!currentEditingCompany) return;
    
    const newName = document.getElementById('editCompanyName').value.trim();
    const newIcon = document.getElementById('editCompanyIcon').value;
    const newStatus = document.getElementById('editCompanyStatus').value;
    
    if (!newName) {
        alert('‚ùå El nombre de la empresa es obligatorio');
        return;
    }
    
    // Actualizar datos de la empresa
    const companies = getCompaniesData();
    if (companies[currentEditingCompany]) {
        companies[currentEditingCompany].name = newName;
        companies[currentEditingCompany].icon = newIcon;
        companies[currentEditingCompany].status = newStatus;
        
        // Guardar en localStorage
        saveCompaniesData(companies);
        
        // Actualizar interfaz
        updateCompanySelector();
        loadManagementList();
    
    showNotification(`üóëÔ∏è Empresa "${company.name}" eliminada correctamente`, 'success');
}
        
        // Si es la empresa actual, actualizar vista
        const currentCompany = getCurrentSelectedCompany();
        if (currentCompany === currentEditingCompany) {
            updateSelectedCompany(currentEditingCompany);
        }
        
        closeEditModal();
        showNotification(`‚úÖ Empresa "${newName}" actualizada correctamente`, 'success');
    }
}

// CERRAR MODAL DE EDICI√ìN
function closeEditModal() {
    document.getElementById('editCompanyModal').style.display = 'none';
    document.getElementById('editCompanyModal').classList.remove('show');
    currentEditingCompany = null;
}

// ELIMINAR EMPRESA (CON C√ìDIGO DE SEGURIDAD)
function deleteCompany(companyId) {
    const companies = getCompaniesData();
    const company = companies[companyId];
    
    if (!company) return;
    
    // Verificar que no sea la √∫nica empresa
    const companyCount = Object.keys(companies).length;
    if (companyCount <= 1) {
        alert('‚ùå No puedes eliminar la √∫nica empresa. Debe haber al menos una empresa activa.');
        return;
    }
    
    // Solicitar c√≥digo de seguridad
    const securityCode = prompt(`üîí CONFIRMACI√ìN DE ELIMINACI√ìN
    
Empresa: ${company.name}
    
‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER
    
Para confirmar la eliminaci√≥n, ingresa el c√≥digo de seguridad:`);
    
    if (securityCode === null) return; // Usuario cancel√≥
    
    if (securityCode !== 'joelgty123456') {
        alert('‚ùå C√≥digo de seguridad incorrecto. Eliminaci√≥n cancelada.');
        return;
    }
    
    // Confirmar eliminaci√≥n
    const confirmDelete = confirm(`‚úÖ C√≥digo correcto.

¬øEst√°s COMPLETAMENTE SEGURO de eliminar "${company.name}"?

Se perder√°n TODOS los datos de esta empresa.

¬øContinuar?`);
    
    if (!confirmDelete) return;
    
    // Eliminar empresa
    delete companies[companyId];
    saveCompaniesData(companies);
    
    // Si era la empresa actual, cambiar a otra
    const currentCompany = getCurrentSelectedCompany();
    if (currentCompany === companyId) {
        const remainingCompanies = Object.keys(companies);
        if (remainingCompanies.length > 0) {
            selectCompany(remainingCompanies[0]);
    
    // Actualizar interfaz    
    updateCompanySelector();
    loadManagementList();
    
    showNotification(`üóëÔ∏è Empresa "${company.name}" eliminada correctamente`, 'success');
}

// GUARDAR DATOS DE EMPRESAS EN LOCALSTORAGE
function saveCompaniesData(companies) {
    localStorage.setItem('grizalum_companies', JSON.stringify(companies));
}

// CARGAR DATOS DE EMPRESAS DESDE LOCALSTORAGE
function loadCompaniesData() {
    const saved = localStorage.getItem('grizalum_companies');
    if (saved) {
        return JSON.parse(saved);
    }
    return getCompaniesData(); // Datos por defecto
}

// ACTUALIZAR SELECTOR DE EMPRESAS
function updateCompanySelector() {
    const companies = loadCompaniesData();
    const companiesList = document.querySelector('.companies-list');
    
    companiesList.innerHTML = '';
    
    Object.entries(companies).forEach(([id, company]) => {
        const item = document.createElement('div');
        item.className = 'company-item';
        item.dataset.company = id;
        item.onclick = () => selectCompany(id);
        
        item.innerHTML = `
            <div class="company-item-icon">${company.icon}</div>
            <div class="company-item-info">
                <div class="company-item-name">${company.name}</div>
                <div class="company-item-stats">Flujo: S/. ${company.data.cashFlow.toLocaleString()}</div>
            </div>
            <div class="company-item-status">${company.status === 'Operativo' ? 'üü¢' : company.status === 'Regular' ? 'üü°' : 'üî¥'}</div>
        `;
        
        companiesList.appendChild(item);
    });
}

// OBTENER EMPRESA ACTUAL SELECCIONADA
function getCurrentSelectedCompany() {
    const activeItem = document.querySelector('.company-item.active');
    return activeItem ? activeItem.dataset.company : null;
}

// ACTUALIZAR FUNCI√ìN getCompaniesData para usar localStorage
function getCompaniesData() {
    const saved = localStorage.getItem('grizalum_companies');
    if (saved) {
        return JSON.parse(saved);
    }
    
    // Datos por defecto (primera vez)
    const defaultCompanies = {
        'fundicion-laguna': {
            name: 'Fundici√≥n Laguna',
            icon: 'üî•',
            status: 'Operativo',
            theme: { primary: '#dc2626', secondary: '#ea580c' },
            data: {
                cashFlow: 24500,
                revenue: 45200,
                expenses: 28700,
                profit: 16500
            }
        },
        'fundicion-joel': {
            name: 'Fundici√≥n Joel',
            icon: 'üî•',
            status: 'Operativo',
            theme: { primary: '#ea580c', secondary: '#f97316' },
            data: {
                cashFlow: 18300,
                revenue: 32100,
                expenses: 21800,
                profit: 10300
            }
        },
        'avicola-san-juan': {
            name: 'Av√≠cola San Juan',
            icon: 'üêî',
            status: 'Operativo',
            theme: { primary: '#059669', secondary: '#10b981' },
            data: {
                cashFlow: 32100,
                revenue: 58300,
                expenses: 41200,
                profit: 17100
            }
        },
        'import-lm': {
            name: 'Import LM',
            icon: 'üì¶',
            status: 'Operativo',
            theme: { primary: '#8b5cf6', secondary: '#a78bfa' },
            data: {
                cashFlow: 45200,
                revenue: 72800,
                expenses: 48600,
                profit: 24200
            }
        },
        'bodega-central': {
            name: 'Bodega Central',
            icon: 'üè™',
            status: 'Regular',
            theme: { primary: '#3b82f6', secondary: '#60a5fa' },
            data: {
                cashFlow: 15800,
                revenue: 28500,
                expenses: 19700,
                profit: 8800
            }
        }
    };
    
    saveCompaniesData(defaultCompanies);
    return defaultCompanies;
}

// AGREGAR BOT√ìN DE GESTI√ìN AL DROPDOWN
function updateDropdownWithManagement() {
    const dropdownFooter = document.querySelector('.dropdown-footer');
    if (dropdownFooter && !document.getElementById('manageCompaniesBtn')) {
        dropdownFooter.innerHTML = `
            <button id="manageCompaniesBtn" class="btn btn-sm btn-neutral" onclick="openCompanyManagement()" style="margin-bottom: 0.5rem; width: 100%;">
                <i class="fas fa-cog"></i>
                Gestionar Empresas
            </button>
            <div class="total-companies">
                <strong>üìä Total Holding: S/. 135,900</strong>
            </div>
        `;
    }
}

// INICIALIZAR AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar selector con datos guardados
    updateCompanySelector();
    updateDropdownWithManagement();
    
    // Cargar empresa por defecto
    const companies = getCompaniesData();
    const firstCompany = Object.keys(companies)[0];
    if (firstCompany) {
        updateSelectedCompany(firstCompany);
    }
});

console.log('‚öôÔ∏è Sistema de gesti√≥n de empresas GRIZALUM cargado');
// FUNCI√ìN PARA CAMBIAR COLORES DE LA IA
function updateAITheme(theme) {
    console.log('üé® Actualizando tema IA:', theme);
    
    const aiButton = document.getElementById('aiAssistantButton');
    const aiHeader = document.querySelector('.ai-panel-header');
    
    if (aiButton && theme) {
        aiButton.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
        console.log('‚úÖ Bot√≥n IA actualizado');
    }
    
    if (aiHeader && theme) {
        aiHeader.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
        console.log('‚úÖ Header IA actualizado');
    }
}    
console.log('üîë C√≥digo de seguridad para eliminaci√≥n configurado');
</script>  
<!-- WIZARD PARA AGREGAR EMPRESAS CON IA -->

<!-- MODAL DEL WIZARD -->
<div id="addCompanyWizard" class="wizard-modal">
    <div class="wizard-container">
        <div class="wizard-header">
            <h2>üöÄ Agregar Nueva Empresa</h2>
            <div class="wizard-steps">
                <div class="step-indicator active" data-step="1">1</div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="2">2</div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="3">3</div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="4">4</div>
            </div>
            <button class="close-wizard" onclick="closeWizard()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- PASO 1: Informaci√≥n B√°sica -->
        <div class="wizard-step active" id="wizardStep1">
            <div class="step-content">
                <div class="step-icon">üìù</div>
                <h3>Informaci√≥n B√°sica</h3>
                <p>Cu√©ntanos sobre tu nueva empresa</p>
                
                <div class="form-group">
                    <label class="form-label">Nombre de la Empresa</label>
                    <input type="text" id="wizardCompanyName" class="form-input" 
                           placeholder="Ej: Zapater√≠a Future, Restaurante El Sol..." 
                           oninput="validateStep1()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Describe tu negocio</label>
                    <textarea id="wizardCompanyDescription" class="form-input" rows="3" 
                              placeholder="Ej: Venta de calzado deportivo y casual para j√≥venes..."
                              oninput="validateStep1()"></textarea>
                </div>
                
                <div class="wizard-actions">
                    <button id="analyzeWithAI" class="btn btn-primary btn-ai" onclick="analyzeWithAI()" disabled>
                        <i class="fas fa-brain"></i>
                        <span class="btn-text">Analizar con IA</span>
                        <div class="ai-loader" style="display: none;">
                            <div class="ai-dots">
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- PASO 2: Sugerencias de IA -->
        <div class="wizard-step" id="wizardStep2">
            <div class="step-content">
                <div class="step-icon">ü§ñ</div>
                <h3>La IA ha analizado tu negocio</h3>
                <p>Estas son nuestras sugerencias inteligentes</p>
                
                <div class="ai-analysis" id="aiAnalysisResults">
                    <!-- Se llena din√°micamente -->
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-neutral" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()">
                        Me gusta, continuar
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- PASO 3: Personalizaci√≥n -->
        <div class="wizard-step" id="wizardStep3">
            <div class="step-content">
                <div class="step-icon">üé®</div>
                <h3>Personalizar Empresa</h3>
                <p>Ajusta los detalles seg√∫n tus preferencias</p>
                
                <div class="customization-grid">
                    <div class="custom-section">
                        <h4>üé® Colores</h4>
                        <div class="color-options" id="colorOptions">
                            <!-- Se llena din√°micamente -->
                        </div>
                        <div class="custom-color-section">
                            <label class="form-label">O elige tu propio color</label>
                            <input type="color" id="customColor" class="color-picker" onchange="applyCustomColor()">
                        </div>
                    </div>
                    
                    <div class="custom-section">
                        <h4>üìä KPIs Principales</h4>
                        <div class="kpi-checklist" id="kpiChecklist">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-neutral" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()">
                        Continuar
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- PASO 4: Vista Previa y Confirmaci√≥n -->
        <div class="wizard-step" id="wizardStep4">
            <div class="step-content">
                <div class="step-icon">‚úÖ</div>
                <h3>¬°Todo listo para crear!</h3>
                <p>Revisa los detalles antes de crear tu empresa</p>
                
                <div class="preview-card" id="previewCard">
                    <!-- Se llena din√°micamente -->
                </div>
                
                <div class="final-options">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="generateSampleData" checked>
                            <span class="checkmark"></span>
                            Generar datos de ejemplo para probar
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="setAsActive" checked>
                            <span class="checkmark"></span>
                            Activar esta empresa inmediatamente
                        </label>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-neutral" onclick="previousStep()">
                        <i class="fas fa-arrow-left"></i>
                        Anterior
                    </button>
                    <button class="btn btn-success" onclick="createCompany()">
                        <i class="fas fa-rocket"></i>
                        ¬°Crear Empresa!
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS PARA EL WIZARD -->
<style>
.wizard-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10001;
    backdrop-filter: blur(8px);
}

.wizard-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 24px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
}

.wizard-header {
    background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
    color: white;
    padding: 2rem;
    position: relative;
}

.wizard-header h2 {
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
    font-weight: 800;
}

.wizard-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background: white;
    color: var(--peru-gold);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}

.step-indicator.completed {
    background: #10b981;
    color: white;
}

.step-line {
    width: 60px;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
}

.step-line.completed {
    background: #10b981;
}

.close-wizard {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.close-wizard:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.wizard-step {
    display: none;
    padding: 3rem;
    min-height: 500px;
}

.wizard-step.active {
    display: block;
    animation: slideIn 0.5s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.step-content {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
}

.step-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.8;
}

.step-content h3 {
    margin-bottom: 0.5rem;
    color: var(--gray-800);
    font-size: 1.8rem;
    font-weight: 700;
}

.step-content p {
    margin-bottom: 2rem;
    color: var(--gray-600);
    font-size: 1.1rem;
}

.btn-ai {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.btn-ai:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-ai:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
}

.ai-loader {
    display: flex;
    align-items: center;
}

.ai-dots {
    display: flex;
    gap: 4px;
}

.dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: dotPulse 1.4s infinite ease-in-out;
}

.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

.wizard-actions {
    margin-top: 3rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.ai-analysis {
    text-align: left;
    background: var(--gray-50);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.analysis-section {
    margin-bottom: 2rem;
}

.analysis-section h4 {
    color: var(--gray-800);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detected-type {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    display: inline-block;
}

.color-preview {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
}

.color-swatch {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.8rem;
}

.kpi-suggestions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.kpi-suggestion {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    border: 2px solid var(--gray-200);
    text-align: center;
}

.customization-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    text-align: left;
}

.custom-section h4 {
    margin-bottom: 1rem;
    color: var(--gray-800);
}

.color-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.color-option {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s ease;
    position: relative;
}

.color-option:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.color-option.selected {
    border-color: var(--peru-gold);
    transform: scale(1.1);
}

.color-option::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.color-option.selected::after {
    opacity: 1;
}

.color-picker {
    width: 60px;
    height: 60px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
}

.kpi-checklist {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.3s ease;
}

.checkbox-label:hover {
    background: var(--gray-50);
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--peru-gold);
}

.preview-card {
    background: var(--gray-50);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: left;
}

.preview-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.preview-icon {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.preview-info h4 {
    margin: 0 0 0.5rem 0;
    color: var(--gray-800);
    font-size: 1.3rem;
}

.preview-info p {
    margin: 0;
    color: var(--gray-600);
}

.final-options {
    margin-bottom: 2rem;
    text-align: left;
}

/* Responsive */
@media (max-width: 768px) {
    .wizard-container {
        width: 95%;
        max-height: 95vh;
    }
    
    .wizard-step {
        padding: 2rem 1.5rem;
    }
    
    .customization-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .wizard-steps {
        gap: 0.5rem;
    }
    
    .step-line {
        width: 30px;
    }
}
</style>

<!-- JAVASCRIPT DEL WIZARD -->
<script>
let currentWizardStep = 1;
let wizardData = {};

// ABRIR WIZARD
function showAddCompanyWizard() {
    currentWizardStep = 1;
    wizardData = {};
    
    // Resetear formulario
    document.getElementById('wizardCompanyName').value = '';
    document.getElementById('wizardCompanyDescription').value = '';
    
    // Mostrar paso 1
    showWizardStep(1);
    
    // Mostrar modal
    document.getElementById('addCompanyWizard').style.display = 'block';
    document.getElementById('addCompanyWizard').classList.add('show');
    
    // Cerrar dropdown de empresas
    toggleCompanyDropdown();
}

// CERRAR WIZARD
function closeWizard() {
    document.getElementById('addCompanyWizard').style.display = 'none';
    document.getElementById('addCompanyWizard').classList.remove('show');
}

// MOSTRAR PASO DEL WIZARD
function showWizardStep(stepNumber) {
    // Ocultar todos los pasos
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Mostrar paso actual
    document.getElementById(`wizardStep${stepNumber}`).classList.add('active');
    
    // Actualizar indicadores
    updateStepIndicators(stepNumber);
    
    currentWizardStep = stepNumber;
}

// ACTUALIZAR INDICADORES DE PASOS
function updateStepIndicators(currentStep) {
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const stepNum = index + 1;
        indicator.classList.remove('active', 'completed');
        
        if (stepNum < currentStep) {
            indicator.classList.add('completed');
            indicator.innerHTML = '<i class="fas fa-check"></i>';
        } else if (stepNum === currentStep) {
            indicator.classList.add('active');
            indicator.innerHTML = stepNum;
        } else {
            indicator.innerHTML = stepNum;
        }
    });
    
    // Actualizar l√≠neas
    document.querySelectorAll('.step-line').forEach((line, index) => {
        line.classList.remove('completed');
        if (index + 1 < currentStep) {
            line.classList.add('completed');
        }
    });
}

// VALIDAR PASO 1
function validateStep1() {
    const name = document.getElementById('wizardCompanyName').value.trim();
    const description = document.getElementById('wizardCompanyDescription').value.trim();
    const button = document.getElementById('analyzeWithAI');
    
    if (name.length >= 3 && description.length >= 10) {
        button.disabled = false;
    } else {
        button.disabled = true;
    }
}

// ANALIZAR CON IA
function analyzeWithAI() {
    const name = document.getElementById('wizardCompanyName').value.trim();
    const description = document.getElementById('wizardCompanyDescription').value.trim();
    
    // Mostrar cargando
    const button = document.getElementById('analyzeWithAI');
    const btnText = button.querySelector('.btn-text');
    const loader = button.querySelector('.ai-loader');
    
    btnText.style.display = 'none';
    loader.style.display = 'flex';
    button.disabled = true;
    
    // Simular an√°lisis IA
    setTimeout(() => {
        const analysis = performAIAnalysis(name, description);
        showAIResults(analysis);
        nextStep();
        
        // Restaurar bot√≥n
        btnText.style.display = 'block';
        loader.style.display = 'none';
        button.disabled = false;
    }, 3000);
}

// REALIZAR AN√ÅLISIS IA
function performAIAnalysis(name, description) {
    const text = (name + ' ' + description).toLowerCase();
    
    // Detectar tipo de negocio
    const businessTypes = {
        'zapateria': {
            type: 'Zapater√≠a/Calzado',
            icon: 'üëü',
            colors: [
                { name: 'Rosa Moderno', primary: '#ec4899', secondary: '#f472b6' },
                { name: 'P√∫rpura Elegante', primary: '#8b5cf6', secondary: '#a78bfa' },
                { name: 'Azul Juvenil', primary: '#3b82f6', secondary: '#60a5fa' }
            ],
            kpis: [
                { name: 'Ventas Diarias', icon: 'üëü', description: 'Pares vendidos por d√≠a' },
                { name: 'Inventario Stock', icon: 'üì¶', description: 'Cantidad de pares en stock' },
                { name: 'Ticket Promedio', icon: 'üí∞', description: 'Venta promedio por cliente' },
                { name: 'Rotaci√≥n Stock', icon: 'üîÑ', description: 'Velocidad de rotaci√≥n de inventario' }
            ]
        },
        'restaurante': {
            type: 'Restaurante/Gastronom√≠a',
            icon: 'üçΩÔ∏è',
            colors: [
                { name: 'Rojo Apetitoso', primary: '#dc2626', secondary: '#ef4444' },
                { name: 'Naranja C√°lido', primary: '#ea580c', secondary: '#f97316' },
                { name: 'Verde Fresco', primary: '#059669', secondary: '#10b981' }
            ],
            kpis: [
                { name: 'Mesas Ocupadas', icon: 'ü™ë', description: 'Porcentaje de ocupaci√≥n' },
                { name: 'Ticket Promedio', icon: 'üçΩÔ∏è', description: 'Consumo promedio por mesa' },
                { name: 'Rotaci√≥n Mesas', icon: 'üîÑ', description: 'Veces que se ocupa cada mesa' },
                { name: 'Satisfacci√≥n', icon: '‚≠ê', description: 'Rating promedio de clientes' }
            ]
        },
        'construccion': {
            type: 'Construcci√≥n/Inmobiliaria',
            icon: 'üèóÔ∏è',
            colors: [
                { name: 'Marr√≥n Tierra', primary: '#92400e', secondary: '#b45309' },
                { name: 'Verde Industrial', primary: '#059669', secondary: '#10b981' },
                { name: 'Gris Acero', primary: '#374151', secondary: '#4b5563' }
            ],
            kpis: [
                { name: 'Proyectos Activos', icon: 'üèóÔ∏è', description: 'Construcciones en proceso' },
                { name: 'Materiales Stock', icon: 'üß±', description: 'Inventario de materiales' },
                { name: 'Equipos Operativos', icon: 'üöõ', description: 'Maquinaria disponible' },
                { name: 'Contratos Pendientes', icon: 'üìã', description: 'Proyectos por iniciar' }
            ]
        },
        'default': {
            type: 'Comercio General',
            icon: 'üè¢',
            colors: [
                { name: 'Azul Corporativo', primary: '#3b82f6', secondary: '#60a5fa' },
                { name: 'Verde √âxito', primary: '#059669', secondary: '#10b981' },
                { name: 'P√∫rpura Premium', primary: '#7c3aed', secondary: '#8b5cf6' }
            ],
            kpis: [
                { name: 'Ventas Mensuales', icon: 'üìà', description: 'Ingresos por ventas' },
                { name: 'Clientes Activos', icon: 'üë•', description: 'Base de clientes' },
                { name: 'Inventario Total', icon: 'üì¶', description: 'Stock disponible' },
                { name: 'Margen Ganancia', icon: 'üí∞', description: 'Rentabilidad promedio' }
            ]
        }
    };
    
    // Detectar tipo
    let detectedType = 'default';
    
    const keywords = {
        'zapateria': ['zapato', 'zapatilla', 'calzado', 'sneaker', 'deportivo', 'tenis'],
        'restaurante': ['restaurante', 'comida', 'cocina', 'chef', 'gastronomia', 'plato'],
        'construccion': ['construccion', 'inmobiliaria', 'casa', 'edificio', 'obra', 'material']
    };
    
    Object.entries(keywords).forEach(([type, words]) => {
        if (words.some(word => text.includes(word))) {
            detectedType = type;
        }
    });
    
    const result = businessTypes[detectedType];
    
    // Guardar en wizardData
    wizardData = {
        name,
        description,
        detectedType: result.type,
        icon: result.icon,
        colors: result.colors,
        kpis: result.kpis,
        selectedColor: result.colors[0],
        selectedKPIs: result.kpis.map(kpi => kpi.name)
    };
    
    return result;
}

// MOSTRAR RESULTADOS IA
function showAIResults(analysis) {
    const container = document.getElementById('aiAnalysisResults');
    
    container.innerHTML = `
        <div class="analysis-section">
            <h4>üéØ Tipo de negocio detectado</h4>
            <div class="detected-type">${analysis.type}</div>
        </div>
        
        <div class="analysis-section">
            <h4>üé® Colores sugeridos</h4>
            <div class="color-preview">
                ${analysis.colors.map(color => 
                    `<div class="color-swatch" style="background: ${color.primary};">${color.name}</div>`
                ).join('')}
            </div>
        </div>
        
        <div class="analysis-section">
            <h4>üìä KPIs recomendados</h4>
            <div class="kpi-suggestions">
                ${analysis.kpis.map(kpi => 
                    `<div class="kpi-suggestion">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${kpi.icon}</div>
                        <strong>${kpi.name}</strong>
                        <p style="font-size: 0.8rem; color: var(--gray-600); margin: 0.25rem 0 0 0;">${kpi.description}</p>
                    </div>`
                ).join('')}
            </div>
        </div>
    `;
}

// SIGUIENTE PASO
function nextStep() {
    if (currentWizardStep < 4) {
        if (currentWizardStep === 2) {
            setupCustomizationStep();
        } else if (currentWizardStep === 3) {
            setupPreviewStep();
        }
        showWizardStep(currentWizardStep + 1);
    }
}

// PASO ANTERIOR
function previousStep() {
    if (currentWizardStep > 1) {
        showWizardStep(currentWizardStep - 1);
    }
}

// CONFIGURAR PASO DE PERSONALIZACI√ìN
function setupCustomizationStep() {
    // Configurar opciones de colores
    const colorContainer = document.getElementById('colorOptions');
    colorContainer.innerHTML = '';
    
    wizardData.colors.forEach((color, index) => {
        const colorDiv = document.createElement('div');
        colorDiv.className = `color-option ${index === 0 ? 'selected' : ''}`;
        colorDiv.style.background = `linear-gradient(135deg, ${color.primary} 0%, ${color.secondary} 100%)`;
        colorDiv.onclick = () => selectColor(index);
        colorContainer.appendChild(colorDiv);
    });
    
    // Configurar checklist de KPIs
    const kpiContainer = document.getElementById('kpiChecklist');
    kpiContainer.innerHTML = '';
    
    wizardData.kpis.forEach(kpi => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        label.innerHTML = `
            <input type="checkbox" checked data-kpi="${kpi.name}">
            <span>${kpi.icon} ${kpi.name}</span>
        `;
        kpiContainer.appendChild(label);
    });
}

// SELECCIONAR COLOR
function selectColor(index) {
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelectorAll('.color-option')[index].classList.add('selected');
    wizardData.selectedColor = wizardData.colors[index];
}

// APLICAR COLOR PERSONALIZADO
function applyCustomColor() {
    const customColor = document.getElementById('customColor').value;
    
    // Deseleccionar colores predefinidos
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Crear color personalizado
    wizardData.selectedColor = {
        name: 'Color Personalizado',
        primary: customColor,
        secondary: customColor
    };
}

// CONFIGURAR PASO DE VISTA PREVIA
function setupPreviewStep() {
    // Recopilar KPIs seleccionados
    const selectedKPIs = [];
    document.querySelectorAll('#kpiChecklist input[type="checkbox"]:checked').forEach(checkbox => {
        const kpiName = checkbox.dataset.kpi;
        const kpi = wizardData.kpis.find(k => k.name === kpiName);
        if (kpi) selectedKPIs.push(kpi);
    });
    
    wizardData.selectedKPIs = selectedKPIs;
    
    // Mostrar vista previa
    const previewContainer = document.getElementById('previewCard');
    previewContainer.innerHTML = `
        <div class="preview-header">
            <div class="preview-icon" style="background: linear-gradient(135deg, ${wizardData.selectedColor.primary} 0%, ${wizardData.selectedColor.secondary} 100%);">
                ${wizardData.icon}
            </div>
            <div class="preview-info">
                <h4>${wizardData.name}</h4>
                <p>${wizardData.detectedType}</p>
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">${wizardData.description}</p>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h5 style="margin-bottom: 0.5rem; color: var(--gray-700);">üé® Colores</h5>
                <div style="display: flex; gap: 0.5rem;">
                    <div style="width: 30px; height: 30px; background: ${wizardData.selectedColor.primary}; border-radius: 6px;"></div>
                    <div style="width: 30px; height: 30px; background: ${wizardData.selectedColor.secondary}; border-radius: 6px;"></div>
                </div>
                <p style="font-size: 0.8rem; color: var(--gray-600); margin-top: 0.25rem;">${wizardData.selectedColor.name}</p>
            </div>
            
            <div>
                <h5 style="margin-bottom: 0.5rem; color: var(--gray-700);">üìä KPIs (${selectedKPIs.length})</h5>
                <div style="font-size: 0.8rem; color: var(--gray-600);">
                    ${selectedKPIs.map(kpi => `${kpi.icon} ${kpi.name}`).join(', ')}
                </div>
            </div>
        </div>
    `;
}

// CREAR EMPRESA
function createCompany() {
    const generateSample = document.getElementById('generateSampleData').checked;
    const setActive = document.getElementById('setAsActive').checked;
    
    // Generar ID √∫nico
    const companyId = 'company_' + Date.now();
    
    // Generar datos de ejemplo si est√° marcado
    let sampleData = {
        cashFlow: 0,
        revenue: 0,
        expenses: 0,
        profit: 0
    };
    
    if (generateSample) {
        sampleData = generateSampleData(wizardData.detectedType);
    }
    
    // Crear objeto de empresa
    const newCompany = {
        name: wizardData.name,
        icon: wizardData.icon,
        status: 'Operativo',
        theme: {
            primary: wizardData.selectedColor.primary,
            secondary: wizardData.selectedColor.secondary
        },
        data: sampleData,
        kpis: wizardData.selectedKPIs,
        createdAt: new Date().toISOString(),
        description: wizardData.description,
        type: wizardData.detectedType
    };
    
    // Agregar a la lista de empresas
    const companies = getCompaniesData();
    companies[companyId] = newCompany;
    saveCompaniesData(companies);
    
    // Actualizar interfaz
    updateCompanySelector();
    
    // Activar si est√° marcado
    if (setActive) {
        selectCompany(companyId);
    }
    
    // Cerrar wizard
    closeWizard();
    
    // Mostrar mensaje de √©xito
    showNotification(`üéâ ¬°Empresa "${wizardData.name}" creada exitosamente!`, 'success');
    
    // Mostrar mensaje con IA
    setTimeout(() => {
        showNotification(`ü§ñ IA: Tu nueva empresa est√° lista para generar ingresos`, 'info');
    }, 2000);
}

// GENERAR DATOS DE EJEMPLO
function generateSampleData(businessType) {
    const generators = {
        'Zapater√≠a/Calzado': () => ({
            cashFlow: Math.floor(Math.random() * 20000) + 10000,
            revenue: Math.floor(Math.random() * 40000) + 20000,
            expenses: Math.floor(Math.random() * 25000) + 15000,
            profit: Math.floor(Math.random() * 15000) + 5000
        }),
        'Restaurante/Gastronom√≠a': () => ({
            cashFlow: Math.floor(Math.random() * 30000) + 15000,
            revenue: Math.floor(Math.random() * 50000) + 25000,
            expenses: Math.floor(Math.random() * 35000) + 20000,
            profit: Math.floor(Math.random() * 20000) + 8000
        }),
        'Construcci√≥n/Inmobiliaria': () => ({
            cashFlow: Math.floor(Math.random() * 50000) + 25000,
            revenue: Math.floor(Math.random() * 80000) + 40000,
            expenses: Math.floor(Math.random() * 60000) + 30000,
            profit: Math.floor(Math.random() * 25000) + 10000
        })
    };
    
    const generator = generators[businessType] || generators['Zapater√≠a/Calzado'];
    return generator();
}

// CERRAR MODAL AL HACER CLIC FUERA
document.addEventListener('click', function(event) {
    const wizard = document.getElementById('addCompanyWizard');
    const wizardContainer = document.querySelector('.wizard-container');
    
    if (wizard && wizard.style.display === 'block' && 
        !wizardContainer.contains(event.target)) {
        closeWizard();
    }
});

// NAVEGACI√ìN CON TECLADO
document.addEventListener('keydown', function(event) {
    const wizard = document.getElementById('addCompanyWizard');
    
    if (wizard && wizard.style.display === 'block') {
        if (event.key === 'Escape') {
            closeWizard();
        } else if (event.key === 'ArrowRight' && currentWizardStep < 4) {
            nextStep();
        } else if (event.key === 'ArrowLeft' && currentWizardStep > 1) {
            previousStep();
        }
    }
});

console.log('üß† Wizard Inteligente GRIZALUM cargado correctamente');
console.log('üéØ Funcionalidades:');
console.log('  ‚Ä¢ Detecci√≥n autom√°tica de tipo de negocio');
console.log('  ‚Ä¢ Sugerencias de colores por industria');
console.log('  ‚Ä¢ KPIs espec√≠ficos del sector');
console.log('  ‚Ä¢ Generaci√≥n de datos de ejemplo');
console.log('  ‚Ä¢ Personalizaci√≥n completa');
</script> 
<!-- IA CONVERSACIONAL Y ASISTENTE INTELIGENTE -->

<!-- BOT√ìN FLOTANTE DE IA -->
<div id="aiAssistantButton" class="ai-assistant-button" onclick="toggleAIAssistant()">
    <div class="ai-icon">
        <i class="fas fa-brain"></i>
    </div>
    <div class="ai-pulse"></div>
    <div class="ai-notifications" id="aiNotifications">0</div>
</div>

<!-- PANEL DEL ASISTENTE IA -->
<div id="aiAssistantPanel" class="ai-assistant-panel">
    <div class="ai-panel-header">
        <div class="ai-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="ai-info">
            <h4>GRIZALUM IA</h4>
            <p id="aiStatus">Analizando tu empresa...</p>
        </div>
        <div class="ai-controls">
            <button class="ai-control-btn" onclick="toggleVoiceMode()" id="voiceToggle">
                <i class="fas fa-microphone-slash"></i>
            </button>
            <button class="ai-control-btn" onclick="clearAIChat()">
                <i class="fas fa-broom"></i>
            </button>
            <button class="ai-control-btn" onclick="toggleAIAssistant()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="ai-insights-section">
        <h5>üéØ Insights Autom√°ticos</h5>
        <div id="aiInsights" class="ai-insights-container">
            <!-- Se llena autom√°ticamente -->
        </div>
    </div>

    <div class="ai-chat-container">
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                <div class="ai-message-avatar">ü§ñ</div>
                <div class="ai-message-content">
                    <p>¬°Hola! Soy tu asistente financiero IA. Puedo ayudarte con:</p>
                    <div class="ai-quick-actions">
                        <button class="quick-action-btn" onclick="askAI('¬øC√≥mo van las ventas?')">üìà ¬øC√≥mo van las ventas?</button>
                        <button class="quick-action-btn" onclick="askAI('¬øPuedo invertir m√°s?')">üí∞ ¬øPuedo invertir?</button>
                        <button class="quick-action-btn" onclick="askAI('Analiza mi flujo de caja')">üíß Analizar flujo</button>
                        <button class="quick-action-btn" onclick="askAI('Dame predicciones')">üîÆ Predicciones</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-chat-input">
            <div class="ai-input-container">
                <input type="text" id="aiChatInput" placeholder="Preg√∫ntame sobre tu empresa..." 
                       onkeydown="handleAIChatKeypress(event)">
                <button class="ai-send-btn" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="ai-voice-btn" onclick="startVoiceInput()" id="voiceInputBtn">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS PARA IA CONVERSACIONAL -->
<style>
.ai-assistant-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: visible;
}

.ai-assistant-button:hover {
    transform: translateY(-5px) scale(1.1);
    box-shadow: 0 15px 40px rgba(99, 102, 241, 0.6);
}

.ai-icon {
    color: white;
    font-size: 1.8rem;
    z-index: 2;
}

.ai-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    opacity: 0.7;
    animation: aiPulse 2s infinite;
}

@keyframes aiPulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.2); opacity: 0.3; }
    100% { transform: scale(1.4); opacity: 0; }
}

.ai-notifications {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.ai-notifications.show {
    opacity: 1;
    transform: scale(1);
    animation: notificationBounce 0.5s ease;
}

@keyframes notificationBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

.ai-assistant-panel {
    position: fixed;
    bottom: 120px;
    right: 30px;
    width: 500px;
    height: 700px;
    background: white;
    border-radius: 24px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    border: 1px solid var(--gray-200);
}

.ai-assistant-panel.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

.ai-panel-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.ai-avatar {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.ai-info {
    flex: 1;
}

.ai-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
    font-weight: 700;
}

.ai-info p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.9;
}

.ai-controls {
    display: flex;
    gap: 0.5rem;
}

.ai-control-btn {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.ai-control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.ai-insights-section {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.ai-insights-section h5 {
    margin: 0 0 1rem 0;
    color: var(--gray-800);
    font-size: 0.9rem;
    font-weight: 700;
}

.ai-insights-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 120px;
    overflow-y: auto;
}

.ai-insight-item {
    background: white;
    padding: 0.75rem;
    border-radius: 8px;
    font-size: 0.8rem;
    border-left: 3px solid;
    cursor: pointer;
    transition: all 0.3s ease;
}

.ai-insight-item:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.ai-insight-item.success { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
.ai-insight-item.warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.05); }
.ai-insight-item.info { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
.ai-insight-item.danger { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }

.ai-chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: calc(100% - 200px);
}

.ai-chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.ai-message, .user-message {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
}

.user-message {
    flex-direction: row-reverse;
}

.ai-message-avatar, .user-message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.ai-message-avatar {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.user-message-avatar {
    background: var(--peru-gold);
    color: white;
}

.ai-message-content, .user-message-content {
    background: var(--gray-50);
    padding: 0.75rem 1rem;
    border-radius: 12px;
    max-width: 280px;
    font-size: 0.9rem;
    line-height: 1.4;
}

.user-message-content {
    background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
    color: white;
}

.ai-message-content p {
    margin: 0 0 0.5rem 0;
}

.ai-message-content p:last-child {
    margin-bottom: 0;
}

.ai-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.quick-action-btn {
    background: white;
    border: 1px solid var(--gray-300);
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--gray-700);
}

.quick-action-btn:hover {
    background: var(--peru-gold);
    color: white;
    border-color: var(--peru-gold);
    transform: translateY(-1px);
}

.ai-chat-input {
    padding: 1rem;
    border-top: 1px solid var(--gray-200);
    background: white;
}

.ai-input-container {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.ai-input-container input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: 20px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s ease;
}

.ai-input-container input:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.ai-send-btn, .ai-voice-btn {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.ai-send-btn {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.ai-voice-btn {
    background: var(--gray-200);
    color: var(--gray-600);
}

.ai-voice-btn.active {
    background: #ef4444;
    color: white;
    animation: voicePulse 1s infinite;
}

@keyframes voicePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.ai-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.ai-voice-btn:hover {
    background: var(--gray-300);
}

.ai-typing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-500);
    font-style: italic;
    font-size: 0.8rem;
}

.typing-dots {
    display: flex;
    gap: 2px;
}

.typing-dot {
    width: 4px;
    height: 4px;
    background: var(--gray-400);
    border-radius: 50%;
    animation: typingDot 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingDot {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .ai-assistant-panel {
        bottom: 20px;
        right: 20px;
        left: 20px;
        width: auto;
        height: 70vh;
    }
    
    .ai-assistant-button {
        bottom: 20px;
        right: 20px;
    }
}

/* Animaciones de entrada */
.ai-insight-item.new {
    animation: slideInRight 0.5s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.ai-message.new {
    animation: messageSlideIn 0.5s ease;
}

@keyframes messageSlideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>

<!-- JAVASCRIPT PARA IA CONVERSACIONAL -->
<script>
let aiAssistantOpen = false;
let voiceMode = false;
let aiInsightsCount = 0;
let recognition = null;
let currentCompanyAnalysis = null;

// INICIALIZAR IA AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
    initializeAI();
    setInterval(updateAIInsights, 30000); // Actualizar cada 30 segundos
    setInterval(generateProactiveInsights, 60000); // Insights cada minuto
});

// INICIALIZAR IA
function initializeAI() {
    setupVoiceRecognition();
    updateAIStatus();
    generateInitialInsights();
    
    console.log('ü§ñ IA Conversacional GRIZALUM inicializada');
}

// TOGGLE PANEL IA
function toggleAIAssistant() {
    const panel = document.getElementById('aiAssistantPanel');
    aiAssistantOpen = !aiAssistantOpen;
    
    if (aiAssistantOpen) {
        panel.classList.add('show');
        updateCurrentCompanyAnalysis();
        // Reset notificaciones
        const notifications = document.getElementById('aiNotifications');
        notifications.textContent = '0';
        notifications.classList.remove('show');
    } else {
        panel.classList.remove('show');
    }
}

// ACTUALIZAR STATUS IA
function updateAIStatus() {
    const currentCompany = getCurrentSelectedCompany();
    const companies = getCompaniesData();
    const company = companies[currentCompany];
    
    const statusElement = document.getElementById('aiStatus');
    
    if (company) {
        statusElement.textContent = `Monitoreando ${company.name}`;
    } else {
        statusElement.textContent = 'Listo para ayudar';
    }
}

// GENERAR INSIGHTS INICIALES
function generateInitialInsights() {
    const insights = [
        {
            type: 'success',
            message: 'üìà Flujo de caja estable este mes',
            action: 'Ver detalles'
        },
        {
            type: 'info',
            message: 'üéØ IA lista para analizar tus datos',
            action: 'Comenzar an√°lisis'
        }
    ];
    
    insights.forEach(insight => addAIInsight(insight));
}

// AGREGAR INSIGHT IA
function addAIInsight(insight) {
    const container = document.getElementById('aiInsights');
    
    const insightElement = document.createElement('div');
    insightElement.className = `ai-insight-item ${insight.type} new`;
    insightElement.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 0.25rem;">${insight.message}</div>
        ${insight.action ? `<div style="font-size: 0.7rem; opacity: 0.8;">üí° ${insight.action}</div>` : ''}
    `;
    
    insightElement.onclick = () => {
        if (insight.action) {
            askAI(insight.message);
        }
    };
    
    container.appendChild(insightElement);
    
    // Limit to 5 insights
    const insights = container.children;
    if (insights.length > 5) {
        container.removeChild(insights[0]);
    }
    
    // Incrementar contador de notificaciones
    if (!aiAssistantOpen) {
        aiInsightsCount++;
        updateNotificationBadge();
    }
}

// ACTUALIZAR BADGE DE NOTIFICACIONES
function updateNotificationBadge() {
    const badge = document.getElementById('aiNotifications');
    badge.textContent = aiInsightsCount;
    badge.classList.add('show');
}

// AN√ÅLISIS PROACTIVO
function generateProactiveInsights() {
    const currentCompany = getCurrentSelectedCompany();
    const companies = getCompaniesData();
    const company = companies[currentCompany];
    
    if (!company) return;
    
    const insights = analyzeCompanyData(company);
    
    // Agregar insight aleatorio cada minuto
    if (insights.length > 0) {
        const randomInsight = insights[Math.floor(Math.random() * insights.length)];
        addAIInsight(randomInsight);
    }
}

// ANALIZAR DATOS DE EMPRESA
function analyzeCompanyData(company) {
    const insights = [];
    const data = company.data;
    
    // An√°lisis de flujo de caja
    if (data.cashFlow > 30000) {
        insights.push({
            type: 'success',
            message: `üí∞ Excelente flujo de caja en ${company.name}`,
            action: 'Ver oportunidades de inversi√≥n'
        });
    } else if (data.cashFlow < 15000) {
        insights.push({
            type: 'warning',
            message: `‚ö†Ô∏è Flujo de caja bajo en ${company.name}`,
            action: 'Sugerencias para mejorar'
        });
    }
    
    // An√°lisis de rentabilidad
    const margin = (data.profit / data.revenue) * 100;
    if (margin > 25) {
        insights.push({
            type: 'success',
            message: `üéØ Excelente margen de ganancia: ${margin.toFixed(1)}%`,
            action: 'Estrategias para mantener'
        });
    } else if (margin < 10) {
        insights.push({
            type: 'danger',
            message: `üö® Margen bajo: ${margin.toFixed(1)}%`,
            action: 'Plan de optimizaci√≥n'
        });
    }
    
    // An√°lisis espec√≠fico por tipo
    if (company.type && company.type.includes('Zapater√≠a')) {
        insights.push({
            type: 'info',
            message: 'üëü Temporada alta de calzado detectada',
            action: 'Optimizar inventario'
        });
    }
    
    return insights;
}

// MANEJAR ENTRADA DE CHAT
function handleAIChatKeypress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendAIMessage();
    }
}

// ENVIAR MENSAJE IA
function sendAIMessage() {
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Agregar mensaje del usuario
    addChatMessage(message, 'user');
    
    // Limpiar input
    input.value = '';
    
    // Mostrar typing indicator
    showAITyping();
    
    // Simular respuesta IA
    setTimeout(() => {
    hideAITyping();
    const response = generateAIResponse(message);
    addChatMessage(response, 'ai');
}, 800 + Math.random() * 500);

// PREGUNTAR A IA (BOTONES R√ÅPIDOS)
function askAI(question) {
    document.getElementById('aiChatInput').value = question;
    sendAIMessage();
}

// AGREGAR MENSAJE AL CHAT
function addChatMessage(message, sender) {
    const container = document.getElementById('aiChatMessages');
    
    const messageElement = document.createElement('div');
    messageElement.className = `${sender}-message new`;
    
    const avatar = sender === 'ai' ? 'ü§ñ' : 'üë§';
    const avatarClass = sender === 'ai' ? 'ai-message-avatar' : 'user-message-avatar';
    const contentClass = sender === 'ai' ? 'ai-message-content' : 'user-message-content';
    
    messageElement.innerHTML = `
        <div class="${avatarClass}">${avatar}</div>
        <div class="${contentClass}">
            <p>${message}</p>
        </div>
    `;
    
    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;
}

// MOSTRAR TYPING INDICATOR
function showAITyping() {
    const container = document.getElementById('aiChatMessages');
    
    const typingElement = document.createElement('div');
    typingElement.className = 'ai-message';
    typingElement.id = 'aiTypingIndicator';
    
    typingElement.innerHTML = `
        <div class="ai-message-avatar">ü§ñ</div>
        <div class="ai-typing">
            <span>IA est√° escribiendo</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    container.appendChild(typingElement);
    container.scrollTop = container.scrollHeight;
}

// OCULTAR TYPING INDICATOR
function hideAITyping() {
    const typingIndicator = document.getElementById('aiTypingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// GENERAR RESPUESTA IA
function generateAIResponse(userMessage) {
    const message = userMessage.toLowerCase();
    const currentCompany = getCurrentSelectedCompany();
    const companies = getCompaniesData();
    const company = companies[currentCompany];
    
    // Respuestas espec√≠ficas
    if (message.includes('ventas') || message.includes('ingresos')) {
    if (company) {
        const growth = Math.random() > 0.5 ? '+' : '';
        const percentage = (Math.random() * 20 - 10).toFixed(1);
        return `üìà ¬°Oye! Las ventas de ${company.name} van ${growth}${percentage}% comparado con el mes pasado. Tienes S/. ${company.data.revenue.toLocaleString()} en ingresos. ${percentage > 0 ? '¬°Est√° jalazo! üöÄ' : 'Hay que meterle m√°s ganas al marketing, pata üí™'}`;
    }
    return 'üìä Hermano, para analizar las ventas necesito que elijas una empresa espec√≠fica primero.';
}
    
  if (message.includes('flujo') || message.includes('caja')) {
    if (company) {
        const status = company.data.cashFlow > 20000 ? 'bac√°n' : 'medio ajustado';
        const advice = company.data.cashFlow > 20000 ? 
            'Ahora s√≠ puedes pensar en invertir en algo m√°s, pues.' : 
            'Te recomiendo apurar las cobranzas y revisar bien los gastos, causa.';
        return `üíß El flujo de caja de ${company.name} est√° ${status}: S/. ${company.data.cashFlow.toLocaleString()}. ${advice}`;
    }
    return 'üí∞ Elige una empresa para ver c√≥mo anda su flujo de caja, pues.';
}
    
   if (message.includes('invertir') || message.includes('inversi√≥n')) {
    if (company) {
        const canInvest = company.data.cashFlow > 25000;
        return canInvest ? 
            `‚úÖ ¬°Dale que s√≠! ${company.name} tiene buena plata para invertir. Con S/. ${company.data.cashFlow.toLocaleString()} en caja, podr√≠as meter m√°s en inventario, marketing digital, o equipos nuevos. ¬°A darle!` :
            `‚ö†Ô∏è Mejor esperamos un toque, pata. ${company.name} necesita mejorar su flujo antes de meterse en inversiones grandes. Tienes S/. ${company.data.cashFlow.toLocaleString()}. Primero enf√≥cate en generar m√°s plata.`;
    }
    return 'üí° Para saber si puedes invertir, elige una empresa primero, compadre.';
}
    
    if (message.includes('predicci√≥n') || message.includes('futuro') || message.includes('pron√≥stico')) {
        if (company) {
            const nextMonth = Math.round(company.data.revenue * (1 + (Math.random() * 0.3 - 0.15)));
            const trend = nextMonth > company.data.revenue ? 'crecimiento' : 'disminuci√≥n';
            return `üîÆ Predicci√≥n para ${company.name} pr√≥ximo mes: S/. ${nextMonth.toLocaleString()} en ingresos (${trend}). Basado en tendencias hist√≥ricas y factores estacionales.`;
        }
        return 'üîÆ Selecciona una empresa para generar predicciones espec√≠ficas.';
    }
    
    if (message.includes('mejor') || message.includes('optimizar')) {
        if (company) {
            const suggestions = [
                'üéØ Enf√≥cate en productos de mayor margen',
                'üì± Implementa marketing digital segmentado',
                '‚è∞ Optimiza horarios de mayor demanda',
                'ü§ù Desarrolla programa de fidelizaci√≥n',
                'üìä Automatiza procesos repetitivos'
            ];
            const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            return `üí° Para optimizar ${company.name}: ${suggestion}. Tambi√©n analic√© tus datos y sugiero revisar gastos operativos que representan ${((company.data.expenses/company.data.revenue)*100).toFixed(1)}% de tus ingresos.`;
        }
        return 'üöÄ Selecciona una empresa para recibir sugerencias de optimizaci√≥n personalizadas.';
    }
    
    if (message.includes('competencia') || message.includes('mercado')) {
        const industryInsights = [
            'üìä El sector retail creci√≥ 8% este trimestre en Per√∫',
            'üè≠ La industria metal√∫rgica est√° en auge (+12%)',
            'üçΩÔ∏è Gastronom√≠a se recuper√≥ post-pandemia (+15%)',
            'üèóÔ∏è Construcci√≥n mantiene crecimiento sostenido (+6%)'
        ];
        const insight = industryInsights[Math.floor(Math.random() * industryInsights.length)];
        return `üåç An√°lisis de mercado: ${insight}. Tu empresa est√° bien posicionada para aprovechar estas tendencias.`;
    }
    
    if (message.includes('gracias') || message.includes('thank')) {
        return 'üòä ¬°De nada! Estoy aqu√≠ 24/7 para ayudarte a hacer crecer tu negocio. ¬øHay algo m√°s que pueda analizar?';
    }
    
   if (message.includes('hola') || message.includes('hello')) {
    const greetings = [
        '¬°Ey, qu√© tal! üëã Listo para revisar tus n√∫meros.',
        '¬°Hola, causa! üöÄ ¬øEn qu√© empresa le metemos ganas hoy?',
        '¬°Saludos, pata! üìä ¬øQu√© KPI quieres que revisemos?'
    ];
    return greetings[Math.floor(Math.random() * greetings.length)];
}
    
    // Respuesta por defecto inteligente
    const responses = [
        `ü§ñ Entiendo que quieres saber sobre "${userMessage}". Para darte una respuesta m√°s precisa, ¬øpodr√≠as ser m√°s espec√≠fico? Puedo ayudarte con an√°lisis financiero, predicciones, optimizaci√≥n y estrategias.`,
        `üí° Interesante pregunta sobre "${userMessage}". Te puedo ayudar mejor si me dices qu√© empresa quieres analizar y qu√© aspecto espec√≠fico te interesa.`,
        `üéØ Sobre "${userMessage}", puedo hacer un an√°lisis detallado. ¬øTe refieres a flujo de caja, ventas, gastos, o algo m√°s espec√≠fico?`
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
}

// LIMPIAR CHAT
function clearAIChat() {
    const container = document.getElementById('aiChatMessages');
    container.innerHTML = `
        <div class="ai-message">
            <div class="ai-message-avatar">ü§ñ</div>
            <div class="ai-message-content">
                <p>Chat limpiado. ¬øEn qu√© puedo ayudarte ahora?</p>
                <div class="ai-quick-actions">
                    <button class="quick-action-btn" onclick="askAI('¬øC√≥mo van las ventas?')">üìà ¬øC√≥mo van las ventas?</button>
                    <button class="quick-action-btn" onclick="askAI('¬øPuedo invertir m√°s?')">üí∞ ¬øPuedo invertir?</button>
                    <button class="quick-action-btn" onclick="askAI('Analiza mi flujo de caja')">üíß Analizar flujo</button>
                    <button class="quick-action-btn" onclick="askAI('Dame predicciones')">üîÆ Predicciones</button>
                </div>
            </div>
        </div>
    `;
}

// ACTUALIZAR AN√ÅLISIS AL CAMBIAR EMPRESA
function updateCurrentCompanyAnalysis() {
    const currentCompany = getCurrentSelectedCompany();
    const companies = getCompaniesData();
    const company = companies[currentCompany];
    
    if (company && company !== currentCompanyAnalysis) {
        currentCompanyAnalysis = company;
        
        // Generar insights espec√≠ficos de la empresa
        setTimeout(() => {
            const insights = analyzeCompanyData(company);
            if (insights.length > 0) {
                addAIInsight(insights[0]);
            }
            
            // Mensaje autom√°tico en el chat
            setTimeout(() => {
                const analysisMessage = `üîÑ Cambi√© el an√°lisis a ${company.name}. Estado actual: Flujo S/. ${company.data.cashFlow.toLocaleString()}, Ingresos S/. ${company.data.revenue.toLocaleString()}. ¬øQu√© quieres analizar?`;
                addChatMessage(analysisMessage, 'ai');
            }, 1000);
        }, 500);
        
        updateAIStatus();
    }
}

// CONFIGURACI√ìN DE VOZ
function setupVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'es-ES';
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('aiChatInput').value = transcript;
            stopVoiceInput();
            
            // Auto-enviar despu√©s de capturar voz
            setTimeout(() => {
                sendAIMessage();
            }, 500);
        };
        
        recognition.onerror = function(event) {
            console.warn('Error de reconocimiento de voz:', event.error);
            stopVoiceInput();
        };
        
        recognition.onend = function() {
            stopVoiceInput();
        };
        
        console.log('üé§ Reconocimiento de voz disponible');
    } else {
        console.warn('‚ö†Ô∏è Reconocimiento de voz no disponible en este navegador');
    }
}

// TOGGLE MODO VOZ
function toggleVoiceMode() {
    voiceMode = !voiceMode;
    const button = document.getElementById('voiceToggle');
    
    if (voiceMode) {
        button.innerHTML = '<i class="fas fa-microphone"></i>';
        button.style.background = 'rgba(16, 185, 129, 0.3)';
        addChatMessage('üé§ Modo voz activado. Puedes hablar directamente para hacer preguntas.', 'ai');
    } else {
        button.innerHTML = '<i class="fas fa-microphone-slash"></i>';
        button.style.background = 'rgba(255, 255, 255, 0.2)';
        addChatMessage('‚å®Ô∏è Modo voz desactivado. Usa el teclado para escribir.', 'ai');
    }
}

// INICIAR ENTRADA DE VOZ
function startVoiceInput() {
    if (!recognition) {
        addChatMessage('‚ùå Reconocimiento de voz no disponible en tu navegador.', 'ai');
        return;
    }
    
    const button = document.getElementById('voiceInputBtn');
    button.classList.add('active');
    button.innerHTML = '<i class="fas fa-stop"></i>';
    
    recognition.start();
    
    addChatMessage('üé§ Escuchando... Habla ahora.', 'ai');
}

// DETENER ENTRADA DE VOZ
function stopVoiceInput() {
    if (recognition) {
        recognition.stop();
    }
    
    const button = document.getElementById('voiceInputBtn');
    button.classList.remove('active');
    button.innerHTML = '<i class="fas fa-microphone"></i>';
}

// OVERRIDE FUNCI√ìN selectCompany PARA ACTUALIZAR IA
const originalSelectCompany = selectCompany;
selectCompany = function(companyId) {
    originalSelectCompany(companyId);
    
    // Actualizar an√°lisis IA
    setTimeout(() => {
        updateCurrentCompanyAnalysis();
    }, 500);
};

// INSIGHTS AUTOM√ÅTICOS ADICIONALES
function generateAdvancedInsights() {
    const companies = getCompaniesData();
    const allCompanies = Object.values(companies);
    
    if (allCompanies.length === 0) return;
    
    // An√°lisis comparativo
    const bestPerformer = allCompanies.reduce((best, current) => 
        current.data.profit > best.data.profit ? current : best
    );
    
    const worstPerformer = allCompanies.reduce((worst, current) => 
        current.data.profit < worst.data.profit ? current : worst
    );
    
    // Insight comparativo
    if (bestPerformer !== worstPerformer) {
        addAIInsight({
            type: 'info',
            message: `üèÜ ${bestPerformer.name} lidera con S/. ${bestPerformer.data.profit.toLocaleString()} de ganancia`,
            action: 'Ver estrategias exitosas'
        });
    }
    
    // An√°lisis de diversificaci√≥n
    const totalProfit = allCompanies.reduce((sum, company) => sum + company.data.profit, 0);
    if (totalProfit > 50000) {
        addAIInsight({
            type: 'success',
            message: `üíé Portfolio s√≥lido: S/. ${totalProfit.toLocaleString()} ganancia total`,
            action: 'Oportunidades de expansi√≥n'
        });
    }
    
    // Alertas de riesgo
    const riskCompanies = allCompanies.filter(company => company.data.cashFlow < 15000);
    if (riskCompanies.length > 0) {
        addAIInsight({
            type: 'warning',
            message: `‚ö†Ô∏è ${riskCompanies.length} empresa(s) con flujo bajo`,
            action: 'Plan de contingencia'
        });
    }
}

// PREDICCIONES AVANZADAS
function generateBusinessPredictions() {
    const currentCompany = getCurrentSelectedCompany();
    const companies = getCompaniesData();
    const company = companies[currentCompany];
    
    if (!company) return;
    
    // Predicci√≥n basada en tendencias
    const monthlyGrowth = Math.random() * 0.2 - 0.1; // -10% a +10%
    const predictedRevenue = Math.round(company.data.revenue * (1 + monthlyGrowth));
    
    const predictionInsight = {
        type: monthlyGrowth > 0 ? 'success' : 'warning',
        message: `üîÆ Predicci√≥n pr√≥ximo mes: S/. ${predictedRevenue.toLocaleString()} (${monthlyGrowth > 0 ? '+' : ''}${(monthlyGrowth * 100).toFixed(1)}%)`,
        action: 'Ver an√°lisis completo'
    };
    
    addAIInsight(predictionInsight);
}

// MONITOREO CONTINUO
function startContinuousMonitoring() {
    // Insights avanzados cada 2 minutos
    setInterval(generateAdvancedInsights, 120000);
    
    // Predicciones cada 3 minutos
    setInterval(generateBusinessPredictions, 180000);
    
    // An√°lisis de alertas cada 90 segundos
    setInterval(() => {
        const currentCompany = getCurrentSelectedCompany();
        const companies = getCompaniesData();
        const company = companies[currentCompany];
        
        if (company) {
            // Alerta de oportunidad
            if (company.data.cashFlow > 40000 && Math.random() > 0.7) {
                addAIInsight({
                    type: 'success',
                    message: 'üöÄ Oportunidad detectada: Momento ideal para expansi√≥n',
                    action: 'Estrategias recomendadas'
                });
            }
            
            // Alerta de optimizaci√≥n
            if (company.data.expenses / company.data.revenue > 0.8 && Math.random() > 0.8) {
                addAIInsight({
                    type: 'danger',
                    message: 'üîß Gastos altos detectados: Optimizaci√≥n necesaria',
                    action: 'Plan de reducci√≥n'
                });
            }
        }
    }, 90000);
}

// COMANDOS DE VOZ AVANZADOS
function processVoiceCommand(command) {
    const cmd = command.toLowerCase();
    
    // Comandos espec√≠ficos
    if (cmd.includes('cambiar empresa') || cmd.includes('cambiar a')) {
        const companies = getCompaniesData();
        const companyNames = Object.values(companies).map(c => c.name.toLowerCase());
        
        for (const [id, company] of Object.entries(companies)) {
            if (cmd.includes(company.name.toLowerCase())) {
                selectCompany(id);
                return `‚úÖ Cambiado a ${company.name}`;
            }
        }
        return '‚ùì No entend√≠ a qu√© empresa quieres cambiar';
    }
    
    if (cmd.includes('abrir wizard') || cmd.includes('nueva empresa')) {
        showAddCompanyWizard();
        return 'üöÄ Abriendo wizard para crear nueva empresa';
    }
    
    if (cmd.includes('exportar') || cmd.includes('descargar')) {
        exportCashFlow();
        return 'üìÑ Iniciando exportaci√≥n de datos';
    }
    
    // Procesar como pregunta normal
    return generateAIResponse(command);
}

// INICIALIZAR MONITOREO AL CARGAR
setTimeout(() => {
    startContinuousMonitoring();
    
    // Mensaje de bienvenida personalizado
    setTimeout(() => {
        const currentCompany = getCurrentSelectedCompany();
        const companies = getCompaniesData();
        const company = companies[currentCompany];
        
        if (company) {
            addChatMessage(`¬°Hola! üëã Estoy monitoreando ${company.name}. Puedo ayudarte con an√°lisis financiero, predicciones y optimizaci√≥n. ¬øQu√© quieres revisar?`, 'ai');
        }
    }, 2000);
}, 5000);

console.log('ü§ñ IA Conversacional GRIZALUM completamente cargada');
console.log('üéØ Caracter√≠sticas activas:');
console.log('  ‚Ä¢ Chat inteligente con contexto empresarial');
console.log('  ‚Ä¢ An√°lisis autom√°tico por empresa');
console.log('  ‚Ä¢ Insights proactivos cada 30-60 segundos');
console.log('  ‚Ä¢ Reconocimiento de voz (si est√° disponible)');
console.log('  ‚Ä¢ Predicciones basadas en datos reales');
console.log('  ‚Ä¢ Monitoreo continuo de alertas');
console.log('  ‚Ä¢ An√°lisis comparativo entre empresas');
console.log('  ‚Ä¢ Respuestas contextuales seg√∫n tipo de negocio');
</script>                    
                </div>
            </header>

            <div class="content-area">
                <!-- DASHBOARD SECTION -->
                <section class="page-section active" id="dashboard">
                    <!-- REAL-TIME INDICATOR -->
                    <div style="margin-bottom: 1rem;">
                        <div class="real-time-indicator">
                            <div class="real-time-dot"></div>
                            <span>Datos actualizados hace 2 minutos</span>
                        </div>
                    </div>

                    <!-- KPI CARDS -->
                    <div class="kpi-grid">
                        <div class="kpi-card cash-flow profit-glow micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Flujo de Caja Actual</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-profit)">
                                    <i class="fas fa-water"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 24,500</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+18.5%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA predice:</strong> Flujo positivo sostenido pr√≥ximos 3 meses
                            </div>
                        </div>

                        <div class="kpi-card revenue micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Ingresos Totales</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-blue)">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 45,200</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+12.3%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA sugiere:</strong> Meta agosto: S/. 52,000 (alcanzable)
                            </div>
                        </div>

                        <div class="kpi-card expenses micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Gastos Operativos</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-loss)">
                                    <i class="fas fa-chart-line-down"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 28,700</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>-5.2%</span>
                                </div>
                                <span>vs mes anterior</span>
                            </div>
                            <div class="ai-prediction">
                                <i class="fas fa-brain ai-prediction-icon"></i>
                                <strong>IA alerta:</strong> Gasto en marketing puede optimizarse 15%
                            </div>
                        </div>

                        <div class="kpi-card profit gold-glow micro-interaction">
                            <div class="kpi-header">
                                <div class="kpi-info">
                                    <h3>Utilidad Neta</h3>
                                    <p class="kpi-period">Julio 2025</p>
                                </div>
                                <div class="kpi-icon" style="background: var(--gradient-gold)">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="kpi-value kpi-value-animation">S/. 16,500</div>
                            <div class="kpi-change">
                                <div class="change-indicator change-positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+28.7%</span>
                                </div>
                                <span>Margen: 36.5%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 73%" title="Meta anual: 73% completado"></div>
                            </div>
                        </div>
                    </div>

                    <!-- CHARTS SECTION -->
                    <div class="charts-section">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-chart-line"></i>
                                    Tendencia de Ingresos vs Gastos
                                </h3>
                                <div class="real-time-indicator">
                                    <div class="real-time-dot"></div>
                                    <span>Tiempo Real</span>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-chart-pie"></i>
                                    Distribuci√≥n de Gastos
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-water"></i>
                                    Flujo de Caja Proyectado
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="chart-icon fas fa-coins"></i>
                                    Aging Cuentas por Cobrar
                                </h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="agingChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- AI INSIGHTS SECTION -->
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-brain"></i>
                                Insights de Inteligencia Artificial
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-primary btn-sm" onclick="generateAIReport()">
                                    <i class="fas fa-magic"></i>
                                    Generar An√°lisis IA
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                <h4 style="color: var(--indigo); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                                    Predicci√≥n de Ventas
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    Basado en datos hist√≥ricos y tendencias actuales, las ventas de agosto podr√≠an alcanzar <strong>S/. 52,000</strong> (+15% vs julio). 
                                    Recomendaci√≥n: Incrementar inventario de productos estrella.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(5, 150, 105, 0.2);">
                                <h4 style="color: var(--profit); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-coins" style="margin-right: 0.5rem;"></i>
                                    Optimizaci√≥n de Cobranzas
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    <strong>3 clientes</strong> est√°n cerca del l√≠mite de cr√©dito. Contactar esta semana podr√≠a recuperar 
                                    <strong>S/. 15,200</strong> y mejorar el flujo de caja en 8 d√≠as.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(217, 119, 6, 0.2);">
                                <h4 style="color: var(--warning); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                    Alerta de Inventario
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    El producto "Material Premium" se agotar√° en <strong>12 d√≠as</strong> al ritmo actual. 
                                    Generar orden de compra por <strong>S/. 8,500</strong> para evitar quiebre de stock.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(184, 115, 51, 0.1) 100%); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.2);">
                                <h4 style="color: var(--peru-gold); margin-bottom: 1rem; font-weight: 700;">
                                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                                    Oportunidad de Ahorro
                                </h4>
                                <p style="color: var(--gray-700); line-height: 1.6;">
                                    Renegociar contrato con proveedor principal podr√≠a ahorrar <strong>S/. 3,200/mes</strong> 
                                    (11% del gasto actual). ROI estimado: 340% anual.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CASH FLOW SECTION -->
                <section class="page-section" id="cash-flow">
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-water"></i>
                                Gesti√≥n de Flujo de Caja
                            </h2>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="exportCashFlow()">
                                    <i class="fas fa-download"></i>
                                    Exportar
                                </button>
                                <button class="btn btn-primary" onclick="showCashFlowForm()">
                                    <i class="fas fa-plus"></i>
                                    Nueva Transacci√≥n
                                </button>
                            </div>
                        </div>

                        <!-- CASH FLOW TABLE -->
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Categor√≠a</th>
                                    <th>Tipo</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Saldo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cashFlowTableBody">
                                <tr>
                                    <td>17/07/2025</td>
                                    <td>Venta productos julio</td>
                                    <td>Ventas</td>
                                    <td>Operativo</td>
                                    <td style="color: var(--profit); font-weight: 700;">+S/. 15,200</td>
                                    <td>-</td>
                                    <td style="color: var(--profit); font-weight: 700;">S/. 24,500</td>
                                    <td>
                                        <button class="btn btn-sm btn-neutral micro-interaction" onclick="editTransaction(1)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- OTHER SECTIONS -->
                <section class="page-section" id="income-statement">
                    <div class="executive-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="card-icon fas fa-chart-pie"></i>
                                Estado de Resultados
                            </h2>
                        </div>
                        <div class="empty-state-executive">
                            <div class="empty-state-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3 class="empty-state-title">M√≥dulo en Desarrollo</h3>
                            <p class="empty-state-subtitle">El Estado de Resultados estar√° disponible pr√≥ximamente.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts - RUTAS DESDE LA RA√çZ -->
    <script src="src/assets/js/main.js"></script>
    <script src="src/assets/js/charts.js"></script>
    <script src="src/assets/js/ai.js"></script>
    
    <script>
    // REGISTRO DEL SERVICE WORKER Y PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async function() {
            try {
                // Registrar Service Worker
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });
                
                console.log('‚úÖ GRIZALUM SW registrado:', registration.scope);
                
                // Manejar actualizaciones
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateAvailableNotification();
                        }
                    });
                });
                
                // Escuchar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', event => {
                    const { type, message } = event.data;
                    
                    switch (type) {
                        case 'OFFLINE_MODE':
                            showOfflineModeNotification(message);
                            break;
                        case 'CACHE_UPDATED':
                            showCacheUpdatedNotification();
                            break;
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error registrando Service Worker:', error);
            }
        });
    }

    // INSTALACI√ìN DE PWA
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üíæ PWA instalable detectada');
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
    });

    // Mostrar prompt de instalaci√≥n
    function showInstallPrompt() {
        const installBanner = document.createElement('div');
        installBanner.id = 'install-banner';
        installBanner.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            animation: slideInRight 0.5s ease;
            max-width: 350px;
        `;
        
        installBanner.innerHTML = `
            <i class="fas fa-download" style="font-size: 1.5rem;"></i>
            <div>
                <div style="margin-bottom: 0.5rem;">¬°Instala GRIZALUM!</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Acceso r√°pido desde tu escritorio</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button id="install-yes" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">Instalar</button>
                <button id="install-no" style="
                    background: rgba(0,0,0,0.2);
                    border: none;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">Despu√©s</button>
            </div>
        `;
        
        document.body.appendChild(installBanner);
        
        // Manejar clicks
        document.getElementById('install-yes').addEventListener('click', installPWA);
        document.getElementById('install-no').addEventListener('click', () => {
            installBanner.remove();
        });
        
        // Auto-hide despu√©s de 10 segundos
        setTimeout(() => {
            if (document.getElementById('install-banner')) {
                installBanner.remove();
            }
        }, 10000);
    }

    // Instalar PWA
    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úÖ PWA instalada exitosamente');
                showSuccessMessage('üéâ GRIZALUM instalado correctamente');
            }
            
            deferredPrompt = null;
            document.getElementById('install-banner')?.remove();
        }
    }

    // Detectar cuando la app fue instalada
    window.addEventListener('appinstalled', (evt) => {
        console.log('üéâ GRIZALUM PWA instalada');
        showSuccessMessage('¬°Bienvenido a GRIZALUM instalado! üöÄ');
    });

    // Notificaciones del sistema
    function showUpdateAvailableNotification() {
        const updateBanner = document.createElement('div');
        updateBanner.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            cursor: pointer;
        `;
        
        updateBanner.innerHTML = `
            <i class="fas fa-sync-alt"></i>
            <div>
                <div>Actualizaci√≥n disponible</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Click para actualizar</div>
            </div>
        `;
        
        updateBanner.addEventListener('click', () => {
            location.reload();
        });
        
        document.body.appendChild(updateBanner);
        
        setTimeout(() => updateBanner.remove(), 8000);
    }

    function showOfflineModeNotification(message) {
        const offlineBanner = document.createElement('div');
        offlineBanner.style.cssText = `
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            text-align: center;
            font-weight: 600;
        `;
        
        offlineBanner.innerHTML = `
            <i class="fas fa-wifi-slash" style="margin-right: 0.5rem;"></i>
            ${message} - Trabajando en modo offline
        `;
        
        document.body.appendChild(offlineBanner);
        
        setTimeout(() => offlineBanner.remove(), 5000);
    }

    // GESTI√ìN DE CONEXI√ìN
    window.addEventListener('online', () => {
        console.log('üåê Conexi√≥n restaurada');
        showSuccessMessage('üåê Conexi√≥n a internet restaurada');
        
        // Sincronizar datos pendientes
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'SYNC_PENDING_DATA'
            });
        }
    });

    window.addEventListener('offline', () => {
        console.log('üì± Trabajando offline');
        showOfflineModeNotification('Sin conexi√≥n a internet');
    });

    // CONFIGURACI√ìN DE ACCESOS DIRECTOS DE TECLADO PARA PWA
    document.addEventListener('keydown', (event) => {
        // Solo funcionar si no estamos escribiendo en un input
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
            return;
        }
        
        // Ctrl/Cmd + Shift + D = Dashboard
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'D') {
            event.preventDefault();
            showSection('dashboard');
        }
        
        // Ctrl/Cmd + Shift + F = Flujo de Caja
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'F') {
            event.preventDefault();
            showSection('cash-flow');
        }
        
        // Ctrl/Cmd + Shift + N = Nueva Transacci√≥n
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'N') {
            event.preventDefault();
            showCashFlowForm();
        }
        
        // Ctrl/Cmd + Shift + I = Instalar PWA
        if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'I') {
            event.preventDefault();
            if (deferredPrompt) {
                installPWA();
            }
        }
    });

    // M√âTRICAS DE RENDIMIENTO
    function trackPerformanceMetrics() {
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const metrics = {
                        loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                        domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                        firstPaint: performance.getEntriesByType('paint')[0]?.startTime || 0,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('üìä M√©tricas de rendimiento:', metrics);
                }, 0);
            });
        }
    }

    // FUNCIONES PARA GESTIONAR CACH√â
    async function clearAppCache() {
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            showSuccessMessage('üóëÔ∏è Cach√© limpiado correctamente');
            location.reload();
        }
    }

    async function getCacheSize() {
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            let totalSize = 0;
            
            for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName);
                const keys = await cache.keys();
                totalSize += keys.length;
            }
            
            return totalSize;
        }
        return 0;
    }

    // INICIALIZACI√ìN DE PWA
    function initializePWA() {
        trackPerformanceMetrics();
        
        // Mostrar informaci√≥n de la app si es la primera visita
        if (!localStorage.getItem('grizalum-first-visit')) {
            setTimeout(() => {
                showWelcomeMessage();
                localStorage.setItem('grizalum-first-visit', 'true');
            }, 3000);
        }
        
        console.log('üöÄ PWA GRIZALUM inicializada correctamente');
    }

    function showWelcomeMessage() {
        const welcomeModal = document.createElement('div');
        welcomeModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        `;
        
        welcomeModal.innerHTML = `
            <div style="
                background: white;
                padding: 3rem;
                border-radius: 24px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
            ">
                <div style="
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 2rem;
                    font-size: 2rem;
                    color: white;
                ">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h2 style="margin-bottom: 1rem; color: #1e293b; font-size: 1.5rem;">¬°Bienvenido a GRIZALUM!</h2>
                <p style="color: #64748b; margin-bottom: 2rem; line-height: 1.6;">
                    Sistema financiero empresarial premium dise√±ado espec√≠ficamente para empresas peruanas. 
                    Gestiona tu flujo de caja, an√°lisis predictivo con IA y contabilidad completa.
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button id="welcome-start" style="
                        background: linear-gradient(135deg, #d4af37 0%, #b87333 100%);
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 12px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Comenzar</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(welcomeModal);
        
        document.getElementById('welcome-start').addEventListener('click', () => {
            welcomeModal.remove();
        });
    }

    // Inicializar PWA cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePWA);
    } else {
        initializePWA();
    }

    // Estilos adicionales para PWA
    const pwaStyles = document.createElement('style');
    pwaStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Estilos para cuando la app est√° instalada */
    @media (display-mode: standalone) {
        body {
            user-select: none;
            -webkit-user-select: none;
        }
        
        .pwa-only {
            display: block !important;
        }
        
        .browser-only {
            display: none !important;
        }
    }

    /* Optimizaciones para pantallas t√°ctiles */
    @media (pointer: coarse) {
        .btn, .nav-link, .kpi-card {
            min-height: 44px;
        }
        
        .form-input {
            font-size: 16px; /* Previene zoom en iOS */
        }
    }

    /* Animaciones optimizadas para PWA */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
    `;
    document.head.appendChild(pwaStyles);
    </script>
</body>
</html>
